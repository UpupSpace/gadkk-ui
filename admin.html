<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GADKk ADMIN v18.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00FFA3; --secondary: #00C2FF; --danger: #FF4500; --dark: #09090b; --card: rgba(24, 24, 27, 0.7); --border: rgba(255,255,255,0.1); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--dark); background-image: radial-gradient(circle at 50% -20%, #1e1e2e 0%, #000 100%); color: #fff; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; margin: 0; overflow-x: hidden; }
        .container { width: 100%; max-width: 480px; position: relative; z-index: 10; animation: fadeUp 0.6s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .logo-area h1 { margin: 0; font-family: 'Rajdhani', sans-serif; font-size: 24px; letter-spacing: 1px; color: #fff; display: flex; align-items: center; gap: 8px; }
        .badge { background: linear-gradient(90deg, var(--secondary), var(--primary)); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 800; }
        
        .lang-switch { display: flex; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 2px; }
        .lang-btn { padding: 4px 10px; border-radius: 16px; font-size: 11px; cursor: pointer; color: #888; transition: 0.3s; font-weight: 600; }
        .lang-btn.active { background: var(--primary); color: #000; box-shadow: 0 0 10px rgba(0,255,163,0.3); }

        .card { background: var(--card); border: 1px solid var(--border); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); position: relative; overflow: hidden; transition: transform 0.2s; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-item { background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 12px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 11px; color: #666; margin-bottom: 4px; }
        .stat-val { font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: 700; color: #eee; }
        .highlight { color: var(--danger); text-shadow: 0 0 10px rgba(255, 69, 0, 0.3); }

        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; transition: 0.2s; margin-top: 5px; font-family: 'Inter', sans-serif; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.8; cursor: not-allowed; filter: brightness(0.8); }
        
        /* ä¿®å¤åçš„ Loader æ ·å¼ */
        .loader { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .btn-connect { background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid var(--border); margin-bottom: 20px; }
        .btn-green { background: linear-gradient(135deg, #00FFA3, #00C2FF); color: #000; box-shadow: 0 4px 15px rgba(0, 255, 163, 0.2); }
        .btn-red { background: linear-gradient(135deg, #FF4500, #C21500); color: #fff; box-shadow: 0 4px 15px rgba(255, 69, 0, 0.2); }

        .input-wrap { position: relative; background: #111; border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; padding: 0 15px; transition: 0.3s; margin-bottom: 10px; }
        .input-wrap:focus-within { border-color: var(--secondary); box-shadow: 0 0 15px rgba(0, 194, 255, 0.1); }
        .input-wrap input { width: 100%; background: none; border: none; color: #fff; font-size: 18px; padding: 16px 0; font-family: 'Rajdhani', sans-serif; outline: none; }
        .suffix { font-size: 12px; color: #666; font-weight: bold; }

        .tabs { display: flex; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--border); }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 12px; color: #666; cursor: pointer; border-radius: 8px; transition: 0.3s; font-weight: 600; }
        .tab.active { background: rgba(255,255,255,0.1); color: #fff; }
        .tab.active.buy { color: var(--secondary); }
        .tab.active.burn { color: var(--danger); }

        .capsule-row { display: flex; gap: 8px; justify-content: flex-end; margin-bottom: 8px; flex-wrap: wrap; }
        .capsule { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
        .cap-gold { background: rgba(255, 215, 0, 0.1); color: #FFD700; border-color: rgba(255, 215, 0, 0.2); }
        .cap-red { background: rgba(255, 69, 0, 0.1); color: #FF4500; border-color: rgba(255, 69, 0, 0.2); }
        .cap-blue { background: rgba(0, 194, 255, 0.1); color: #00C2FF; border-color: rgba(0, 194, 255, 0.2); }
        
        .helper-text { text-align: right; font-size: 12px; height: 20px; color: #555; font-family: 'Rajdhani', sans-serif; }
        .hidden { display: none; }

        .toast-box { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; background: rgba(20, 20, 20, 0.95); border-left: 4px solid; padding: 15px 20px; border-radius: 4px; color: #fff; min-width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: translateX(120%); transition: 0.3s; font-size: 13px; display: flex; align-items: center; backdrop-filter: blur(10px); }
        .toast.show { transform: translateX(0); }
        .t-icon { margin-right: 10px; font-size: 16px; }
    </style>
</head>
<body>

<div class="toast-box" id="toastBox"></div>

<div class="container">
    <div class="header-row">
        <div class="logo-area">
            <h1>GADKk <span class="badge">PRO v18</span></h1>
            <div class="subtitle">FINANCIAL COMMAND CENTER</div>
        </div>
        <div class="lang-switch">
            <div class="lang-btn active" id="lang-cn" onclick="setLang('cn')">CN</div>
            <div class="lang-btn" id="lang-en" onclick="setLang('en')">EN</div>
        </div>
    </div>

    <button id="connectBtn" class="btn btn-connect" onclick="connectWallet()">
        <span data-i18n="verify_admin">ğŸ”‘ éªŒè¯ç®¡ç†å‘˜èº«ä»½</span>
    </button>

    <div class="card">
        <div class="card-header">
            <span data-i18n="lp_fund">ğŸ›¡ï¸ è‡ªåŠ¨å›æµ (LP Fund)</span>
            <span style="color:var(--primary)">â— Active</span>
        </div>
        <div class="grid" style="grid-template-columns: 1fr;">
            <div class="stat-item">
                <div class="stat-label" data-i18n="accumulated">å¾…åŠ æ± ä»£å¸ (Accumulated)</div>
                <div class="stat-val" style="color:var(--primary)" id="lpFundBalance">--</div>
            </div>
        </div>
        <button class="btn btn-green" id="btn-process" onclick="processLP()">
            <span data-i18n="btn_process">âš¡ æ‰§è¡Œå›æµåŠ æ±  (PROCESS)</span>
        </button>
    </div>

    <div class="card" style="border-color: rgba(255, 69, 0, 0.2);">
        <div class="card-header">
            <span data-i18n="auto_buyback">ğŸš€ æ™ºèƒ½å›è´­ (Auto Buyback)</span>
            <span style="color:var(--danger)">â— Ready</span>
        </div>

        <div class="grid">
            <div class="stat-item">
                <div class="stat-label" data-i18n="marketing_bal">ğŸ¦ è¥é”€é’±åŒ…ä½™é¢</div>
                <div class="stat-val" id="marketingBal">0.00</div>
            </div>
            <div class="stat-item">
                <div class="stat-label" data-i18n="remaining_vol">âš ï¸ å‰©ä½™æœªæ¶ˆé™¤æŠ›å‹</div>
                <div class="stat-val highlight" id="marketVolume">0.00</div>
            </div>
            <div class="stat-item">
                <div class="stat-label" data-i18n="backlog">ğŸ“‰ å¾…å¤„ç†ç§¯å‹</div>
                <div class="stat-val" style="color:#FFD700" id="ledgerBacklog">0.00</div>
            </div>
            <div class="stat-item">
                <div class="stat-label" data-i18n="usdt_vault">ğŸ’° USDT é‡‘åº“</div>
                <div class="stat-val" id="usdtBalance">--</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active buy" id="tab-usdt" onclick="switchMode('usdt')">
                <span data-i18n="tab_usdt">æŒ‰é‡‘é¢ä¹° (USDT)</span>
            </div>
            <div class="tab" id="tab-adkk" onclick="switchMode('adkk')">
                <span data-i18n="tab_adkk">æŒ‰æ•°é‡ä¹° (ADKK)</span>
            </div>
        </div>

        <div id="mode-usdt">
            <div class="capsule-row">
                <div class="capsule cap-blue" onclick="fillMaxUSDT()">
                    <span data-i18n="fill_max">ğŸ’° å¡«å…¥æœ€å¤§ä½™é¢</span>
                </div>
            </div>
            <div class="input-wrap">
                <input type="number" id="inputUSDT" placeholder="0.00" oninput="calcFromUSDT()">
                <span class="suffix">USDT</span>
            </div>
            <div class="helper-text" id="previewFromUSDT" style="color:var(--secondary)"></div>
            <button class="btn" id="btn-buy-usdt" style="background: var(--secondary); color:#000" onclick="buyByUSDT()">
                <span data-i18n="btn_buy">ğŸ”µ ç¡®è®¤ä¹°å…¥ (BUY)</span>
            </button>
        </div>

        <div id="mode-adkk" class="hidden">
            <div class="capsule-row">
                <div class="capsule cap-gold" onclick="fillBacklog()">
                    <span data-i18n="fill_backlog">ğŸ“‰ å¡«å…¥ç§¯å‹</span>
                </div>
                <div class="capsule cap-red" onclick="fillVolume()">
                    <span data-i18n="fill_vol">âš ï¸ å¡«å…¥æŠ›å‹</span>
                </div>
            </div>
            <div class="input-wrap">
                <input type="number" id="inputADKK" placeholder="0.00" oninput="calcFromADKK()">
                <span class="suffix">ADKK</span>
            </div>
            <div class="helper-text" id="previewFromADKK" style="color:var(--danger)"></div>
            <button class="btn btn-red" id="btn-buy-adkk" onclick="buyByADKK()">
                <span data-i18n="btn_pull">ğŸ”¥ å¼ºåŠ›æ‹‰ç›˜ (PULL)</span>
            </button>
        </div>
    </div>
</div>

<script>
    const i18n = {
        cn: {
            verify_admin: "ğŸ”‘ éªŒè¯ç®¡ç†å‘˜èº«ä»½",
            lp_fund: "ğŸ›¡ï¸ è‡ªåŠ¨å›æµ (LP Fund)",
            accumulated: "å¾…åŠ æ± ä»£å¸ (Accumulated)",
            btn_process: "âš¡ æ‰§è¡Œå›æµåŠ æ±  (PROCESS)",
            auto_buyback: "ğŸš€ æ™ºèƒ½å›è´­ (Auto Buyback)",
            marketing_bal: "ğŸ¦ è¥é”€é’±åŒ…ä½™é¢",
            remaining_vol: "âš ï¸ å‰©ä½™æœªæ¶ˆé™¤æŠ›å‹",
            backlog: "ğŸ“‰ å¾…å¤„ç†ç§¯å‹",
            usdt_vault: "ğŸ’° USDT é‡‘åº“",
            tab_usdt: "æŒ‰é‡‘é¢ä¹° (USDT)",
            tab_adkk: "æŒ‰æ•°é‡ä¹° (ADKK)",
            fill_max: "ğŸ’° å¡«å…¥æœ€å¤§ä½™é¢",
            fill_backlog: "ğŸ“‰ å¡«å…¥ç§¯å‹",
            fill_vol: "âš ï¸ å¡«å…¥æŠ›å‹",
            btn_buy: "ğŸ”µ ç¡®è®¤ä¹°å…¥ (BUY)",
            btn_pull: "ğŸ”¥ å¼ºåŠ›æ‹‰ç›˜ (PULL)",
            toast_connect: "ç³»ç»Ÿè¿æ¥æˆåŠŸ",
            toast_sent: "äº¤æ˜“å·²å‘é€",
            toast_success: "ğŸš€ æ“ä½œæˆåŠŸï¼",
            toast_error: "å¤±è´¥: ",
            balance_low: " (ä½™é¢ä¸è¶³)"
        },
        en: {
            verify_admin: "ğŸ”‘ Verify Admin Access",
            lp_fund: "ğŸ›¡ï¸ LP Fund Auto-Add",
            accumulated: "Accumulated Tokens",
            btn_process: "âš¡ Process LP",
            auto_buyback: "ğŸš€ Auto Buyback System",
            marketing_bal: "ğŸ¦ Marketing Balance",
            remaining_vol: "âš ï¸ Remaining Volume",
            backlog: "ğŸ“‰ Pending Backlog",
            usdt_vault: "ğŸ’° USDT Vault",
            tab_usdt: "Buy by Amount (USDT)",
            tab_adkk: "Buy by Volume (ADKK)",
            fill_max: "ğŸ’° Max Balance",
            fill_backlog: "ğŸ“‰ Fill Backlog",
            fill_vol: "âš ï¸ Fill Volume",
            btn_buy: "ğŸ”µ Confirm Buy (BUY)",
            btn_pull: "ğŸ”¥ Power Pull (PULL)",
            toast_connect: "System Connected",
            toast_sent: "Transaction Sent",
            toast_success: "ğŸš€ Success!",
            toast_error: "Error: ",
            balance_low: " (Insufficient Balance)"
        }
    };

    const BUYBACK_ADDR  = "0xa09e77ed31810b6Ec99b39f0E137c83450Fc8127"; 
    const GADKK_ADDR    = "0xA1aEE242C69E1c0820d165ef12438e0A5eEd0BbA"; 
    const LP_FUND_ADDR  = "0xD7bB38219D069dfDD4F09Fdf568493A4B7d7E4fd"; 
    const MARKETING_ADDR= "0x2DBE6300514C4D0Cd7456348512370D3A68d4c1E"; 
    const USDT_ADDR     = "0x55d398326f99059fF775485246999027B3197955"; 
    const PAIR_ADDR     = "0x5B06dc147F363aa0111549fb5EA992A40feda6fC"; 
    const MARKETING_TAX_RATE = 0.05; 

    const ABI_COMMON = ["function balanceOf(address) view returns (uint256)"];
    const ABI_LP = ["function process() external"];
    const ABI_BUY = ["function buyAndAutoSend(uint256 usdtAmount, uint256 backlogReduced) external", "function totalProcessedBacklog() view returns (uint256)"];

    let provider, signer, currentPrice = 0, backlog = 0, volume = 0, vaultBalance = 0;
    let currentLang = localStorage.getItem('gadkk_admin_lang') || 'cn';

    window.onload = () => setLang(currentLang);

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('gadkk_admin_lang', lang);
        document.getElementById('lang-cn').classList.toggle('active', lang === 'cn');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(i18n[lang][key]) el.innerText = i18n[lang][key];
        });
    }

    function fmtNum(n) {
        return parseFloat(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function showToast(msg, type='info') {
        const div = document.createElement('div');
        div.className = `toast`;
        div.style.borderLeftColor = type==='success'?'var(--primary)':(type==='error'?'var(--danger)':'var(--secondary)');
        const icon = type==='success'?'âœ…':(type==='error'?'âŒ':'â„¹ï¸');
        div.innerHTML = `<span class="t-icon">${icon}</span><span>${msg}</span>`;
        document.getElementById('toastBox').appendChild(div);
        setTimeout(()=>div.classList.add('show'),10);
        setTimeout(()=>{div.classList.remove('show');setTimeout(()=>div.remove(),300)},3000);
    }

    // ğŸ‰ æ™ºèƒ½çƒŸèŠ±
    function smartCelebrate() {
        const isMobile = window.innerWidth < 768;
        const count = isMobile ? 60 : 150; 
        const duration = 2000;
        const end = Date.now() + duration;

        (function frame() {
            confetti({ particleCount: isMobile ? 3 : 7, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#FF4500', '#FFD700'] });
            confetti({ particleCount: isMobile ? 3 : 7, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#FF4500', '#FFD700'] });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    // åº†ç¥åŠ æ± 
    function celebrateLP() {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00FFA3', '#00C2FF'] });
    }

    function switchMode(mode) {
        document.getElementById('mode-usdt').classList.add('hidden');
        document.getElementById('mode-adkk').classList.add('hidden');
        document.getElementById('tab-usdt').classList.remove('active','buy');
        document.getElementById('tab-adkk').classList.remove('active','burn');
        document.getElementById(`mode-${mode}`).classList.remove('hidden');
        const btn = document.getElementById(`tab-${mode}`);
        btn.classList.add('active');
        if(mode==='usdt') btn.classList.add('buy');
        if(mode==='adkk') btn.classList.add('burn');
    }

    async function connectWallet() {
        if(!window.ethereum) return showToast("MetaMask Missing", "error");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const addr = await signer.getAddress();
            document.getElementById("connectBtn").innerText = `âœ… ${addr.substring(0,6)}...`;
            document.getElementById("connectBtn").style.borderColor = "var(--primary)";
            document.getElementById("connectBtn").style.color = "var(--primary)";
            showToast(i18n[currentLang].toast_connect, "success");
            refreshData();
            setInterval(refreshData, 8000);
        } catch(e) { showToast("Canceled", "info"); }
    }

    async function refreshData() {
        if(!provider) return;
        const tkCt = new ethers.Contract(GADKK_ADDR, ABI_COMMON, provider);
        const usdtCt = new ethers.Contract(USDT_ADDR, ABI_COMMON, provider);
        const buyCt = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, provider);

        try {
            const lpVal = await tkCt.balanceOf(LP_FUND_ADDR);
            document.getElementById("lpFundBalance").innerText = fmtNum(ethers.utils.formatUnits(lpVal, 18));
            
            const usdtVal = await usdtCt.balanceOf(BUYBACK_ADDR);
            vaultBalance = parseFloat(ethers.utils.formatUnits(usdtVal, 18));
            document.getElementById("usdtBalance").innerText = fmtNum(vaultBalance);

            const pAdkk = parseFloat(ethers.utils.formatUnits(await tkCt.balanceOf(PAIR_ADDR), 18));
            const pUsdt = parseFloat(ethers.utils.formatUnits(await usdtCt.balanceOf(PAIR_ADDR), 18));
            if(pAdkk>0) currentPrice = pUsdt / pAdkk;

            const realMark = parseFloat(ethers.utils.formatUnits(await tkCt.balanceOf(MARKETING_ADDR), 18));
            document.getElementById("marketingBal").innerText = fmtNum(realMark);
            
            const processed = parseFloat(ethers.utils.formatUnits(await buyCt.totalProcessedBacklog(), 18));
            backlog = Math.max(0, realMark - processed);
            document.getElementById("ledgerBacklog").innerText = fmtNum(backlog);
            
            volume = backlog / MARKETING_TAX_RATE;
            document.getElementById("marketVolume").innerText = fmtNum(volume);
        } catch(e) { console.error(e); }
    }

    function calcFromUSDT() {
        const val = parseFloat(document.getElementById("inputUSDT").value||0);
        if(currentPrice>0) document.getElementById("previewFromUSDT").innerText = `â‰ˆ ${fmtNum(val/currentPrice)} ADKK`;
    }
    function calcFromADKK() {
        const val = parseFloat(document.getElementById("inputADKK").value||0);
        const cost = val * currentPrice;
        const el = document.getElementById("previewFromADKK");
        el.innerText = `â‰ˆ ${cost.toFixed(4)} USDT`;
        el.style.color = cost > vaultBalance ? '#FF4500' : 'var(--danger)';
        if(cost > vaultBalance) el.innerText += i18n[currentLang].balance_low;
    }
    
    function fillMaxUSDT() { document.getElementById("inputUSDT").value = vaultBalance.toFixed(4); calcFromUSDT(); }
    function fillVolume() { document.getElementById("inputADKK").value = volume.toFixed(2); calcFromADKK(); }
    function fillBacklog() { document.getElementById("inputADKK").value = (backlog / MARKETING_TAX_RATE).toFixed(2); calcFromADKK(); } 

    // ğŸ”¥ ç»ˆæä¿®å¤ï¼šå¤‡ä»½åŸå§‹ HTMLï¼Œå¼ºåˆ¶è¿˜åŸ
    function setBtnLoading(id, isLoading) {
        const btn = document.getElementById(id);
        if(!btn) return;
        
        if(isLoading) {
            // 1. å¤‡ä»½åŸå†…å®¹åˆ° dataset (å¦‚æœè¿˜æ²¡å¤‡ä»½è¿‡)
            if(!btn.dataset.orgHtml) btn.dataset.orgHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> Processing...`;
        } else {
            // 2. è¿˜åŸå†…å®¹
            btn.disabled = false;
            if(btn.dataset.orgHtml) {
                btn.innerHTML = btn.dataset.orgHtml;
            }
            // 3. é‡æ–°åˆ·ä¸€éè¯­è¨€ï¼Œé˜²æ­¢æ–‡å­—å˜æˆé»˜è®¤è¯­è¨€
            setLang(currentLang);
        }
    }

    async function executeBuy(usdtAmt, adkkVolumeAmt, btnId) {
        if(!signer) return showToast("Connect Wallet First", "error");
        
        setBtnLoading(btnId, true); // å¼€å§‹è½¬åœˆ
        const ct = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, signer);
        try {
            showToast("Sending...", "info");
            const intendedTaxReduction = adkkVolumeAmt * MARKETING_TAX_RATE;
            const actualBacklogToReduce = intendedTaxReduction > backlog ? backlog : intendedTaxReduction;

            const tx = await ct.buyAndAutoSend(
                ethers.utils.parseUnits(usdtAmt.toFixed(18), 18),
                ethers.utils.parseUnits(actualBacklogToReduce.toFixed(18), 18),
                { gasLimit: 1000000 }
            );
            showToast(i18n[currentLang].toast_sent, "info");
            await tx.wait();
            
            smartCelebrate(); 
            showToast(i18n[currentLang].toast_success, "success");
            
            document.getElementById("inputUSDT").value = "";
            document.getElementById("inputADKK").value = "";
            
            // ğŸ›‘ äº¤æ˜“å®Œæˆï¼Œç«‹å³åœæ­¢è½¬åœˆï¼
            setBtnLoading(btnId, false);
            refreshData();
        } catch(e) { 
            showToast(i18n[currentLang].toast_error + (e.reason || e.message), "error");
            setBtnLoading(btnId, false); // å¤±è´¥ä¹Ÿè¦åœæ­¢è½¬åœˆï¼
        }
    }

    function buyByUSDT() {
        const val = parseFloat(document.getElementById("inputUSDT").value);
        if(!val || val<=0) return showToast("Invalid Input", "error");
        if(val > vaultBalance) return showToast("Low Balance", "error");
        const estimatedVolume = val / currentPrice;
        executeBuy(val, estimatedVolume, 'btn-buy-usdt');
    }

    function buyByADKK() {
        const val = parseFloat(document.getElementById("inputADKK").value);
        if(!val || val<=0) return showToast("Invalid Input", "error");
        const cost = val * currentPrice;
        if(cost > vaultBalance) return showToast("Low Balance", "error");
        executeBuy(cost, val, 'btn-buy-adkk');
    }

    async function processLP() {
        if(!signer) return showToast("Connect Wallet", "error");
        setBtnLoading('btn-process', true);
        
        const ct = new ethers.Contract(LP_FUND_ADDR, ABI_LP, signer);
        try {
            showToast("Processing...", "info");
            const tx = await ct.process({ gasLimit: 3000000 });
            await tx.wait();
            celebrateLP();
            showToast(i18n[currentLang].toast_success, "success");
            
            setBtnLoading('btn-process', false); // ç«‹å³è¿˜åŸ
            refreshData();
        } catch(e) { 
            showToast(e.message, "error"); 
            setBtnLoading('btn-process', false); // å¤±è´¥è¿˜åŸ
        }
    }
</script>
</body>
</html>
