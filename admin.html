<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GADKk ADMIN v4.0 (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* UI æ ·å¼ */
        * { box-sizing: border-box; }
        body { background-color: #050505; background-image: linear-gradient(rgba(0, 255, 163, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 163, 0.03) 1px, transparent 1px); background-size: 40px 40px; color: #fff; font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 500px; }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; font-family: 'Rajdhani', sans-serif; letter-spacing: 4px; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .version-tag { background: #333; color: #FFD700; padding: 2px 6px; border-radius: 4px; font-size: 12px; vertical-align: middle; margin-left: 10px; }
        .subtitle { font-size: 12px; color: #666; letter-spacing: 2px; margin-top: 5px; }
        .card { background: rgba(20, 20, 20, 0.9); border: 1px solid #333; backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .card-green::before { background: #00FFA3; }
        .card-red::before { background: #FF4500; }
        .card-header { display: flex; justify-content: space-between; align-items: center; color: #aaa; font-size: 13px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 5px currentColor; }
        .big-num { font-size: 36px; font-weight: bold; margin: 10px 0; font-family: 'Rajdhani', sans-serif; display: flex; align-items: baseline; }
        .unit { font-size: 16px; color: #666; font-weight: normal; margin-left: 5px; }
        
        /* é—´è°ç›‘æ§åŒºåŸŸå¢å¼º */
        .spy-box { background: rgba(0, 0, 0, 0.4); border: 1px solid #444; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .spy-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #333; }
        .spy-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .spy-label { font-size: 13px; color: #888; }
        .spy-val { font-size: 18px; color: #fff; font-family: 'Rajdhani', sans-serif; font-weight: bold; }
        .highlight { color: #FF4500; font-size: 22px; text-shadow: 0 0 10px rgba(255, 69, 0, 0.3); }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; letter-spacing: 1px; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
        .btn:active { transform: scale(0.98); }
        .btn-connect { background: #333; color: #fff; border: 1px solid #555; margin-bottom: 20px; }
        .btn-green { background: linear-gradient(90deg, #00FFA3, #00C2FF); color: #000; box-shadow: 0 0 20px rgba(0, 255, 163, 0.2); }
        .btn-red { background: linear-gradient(90deg, #FF4500, #FF0055); color: #fff; box-shadow: 0 0 20px rgba(255, 69, 0, 0.2); }
        
        .input-group { display: flex; align-items: center; background: #111; border: 1px solid #333; border-radius: 8px; padding: 5px 10px; margin-bottom: 15px; position: relative; }
        .input-group input { flex: 1; background: transparent; border: none; color: #fff; font-size: 18px; padding: 10px; font-family: 'Rajdhani', sans-serif; outline: none; }
        .input-label { color: #555; font-size: 14px; margin-right: 5px; }
        .cost-preview { position: absolute; right: 10px; top: -25px; font-size: 12px; color: #00FFA3; }
        .auto-fill { color: #00FFA3; font-size: 12px; cursor: pointer; margin-left: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>GADKk ADMIN <span class="version-tag">v4.0</span></h1>
        <div class="subtitle">Finance Control Center</div>
    </div>

    <button id="connectBtn" class="btn btn-connect" onclick="connectWallet()">ğŸ”‘ ç‚¹å‡»è¿æ¥ç®¡ç†å‘˜ (Login)</button>

    <div class="card card-green">
        <div class="card-header">
            <span>ğŸ›¡ï¸ è‡ªåŠ¨å›æµåŸºé‡‘ (LP Fund)</span>
            <span style="color: #00FFA3">â— Active</span>
        </div>
        <div style="font-size:12px; color:#888;">å¾…åŠ æ± ä»£å¸ (Accumulated):</div>
        <div class="big-num" style="color: #00FFA3">
            <span id="lpFundBalance">--</span>
            <span class="unit">ADKK</span>
        </div>
        <button class="btn btn-green" onclick="processLP()">âš¡ æ‰§è¡Œå›æµåŠ æ±  (PROCESS)</button>
    </div>

    <div class="card card-red">
        <div class="card-header">
            <span>ğŸš€ æ™ºèƒ½å›è´­ (Buyback V5)</span>
            <span style="color: #FF4500">â— Ready</span>
        </div>
        
        <div class="spy-box">
            <div class="spy-row">
                <span class="spy-label">ğŸ’° è¥é”€é’±åŒ…ç§¯å‹ (Backlog)</span>
                <span class="spy-val" id="taxBacklog">0.00 ADKK</span>
            </div>
            <div class="spy-row">
                <span class="spy-label">âš ï¸ ä¼°ç®—å¸‚åœºæŠ›å‹ (Volume)</span>
                <span class="spy-val highlight" id="impliedVolume">0.00 ADKK</span>
            </div>
            <div class="spy-row" style="border:none; justify-content: flex-end;">
                <span class="auto-fill" onclick="fillRec()">[è‡ªåŠ¨å¡«å…¥å»ºè®®å€¼]</span>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:25px; font-size:12px; color:#888;">
            <span>é‡‘åº“ä½™é¢: <span id="usdtBalance" style="color:#fff">--</span> USDT</span>
            <span style="color:#666">å®æ—¶å¸ä»·: <span id="tokenPrice">è®¡ç®—ä¸­...</span> U</span>
        </div>

        <div class="input-group">
            <div class="cost-preview" id="costPreview">æ¶ˆè€—: 0.00 USDT</div>
            <span class="input-label">å›è´­æ•°é‡:</span>
            <input type="number" id="targetAdkk" placeholder="è¾“å…¥ ADKK æ•°é‡" oninput="calculateCost()">
            <span style="color:#666; font-size:12px;">ADKK</span>
        </div>

        <button class="btn btn-red" onclick="triggerBuyback()">ğŸ”¥ å¼ºåŠ›æ‹‰ç›˜ (BUY)</button>
    </div>
</div>

<script>
    // --- é…ç½® ---
    const GADKK_ADDR    = "0xA1aEE242C69E1c0820d165ef12438e0A5eEd0BbA"; 
    const LP_FUND_ADDR  = "0xD7bB38219D069dfDD4F09Fdf568493A4B7d7E4fd"; 
    const BUYBACK_ADDR  = "0x3f22B4f6d76dD740AE3E22eb25bC22a884971ADB"; 
    const MARKETING_ADDR= "0x2DBE6300514C4D0Cd7456348512370D3A68d4c1E"; 
    const USDT_ADDR     = "0x55d398326f99059fF775485246999027B3197955"; 
    const PAIR_ADDR     = "0x5B06dc147F363aa0111549fb5EA992A40feda6fC"; // LP æ± åœ°å€ (ç”¨äºæŸ¥ä»·æ ¼)
    
    const MARKETING_TAX_RATE = 0.05; // 5% ç¨ç‡

    const ABI_COMMON = ["function balanceOf(address) view returns (uint256)"];
    const ABI_LP     = ["function process() external"]; 
    const ABI_BUY    = ["function buyUSDT(uint256) external", "function lastMarkBalance() view returns (uint256)"]; 

    let provider, signer;
    let currentPrice = 0; // å®æ—¶ä»·æ ¼
    let impliedVol = 0;   // æŠ›å‹é‡
    let usdtCost = 0;     // éœ€è¦èŠ±è´¹çš„ USDT

    // --- è¿æ¥ ---
    async function connectWallet() {
        if (!window.ethereum) return alert("æœªæ£€æµ‹åˆ° MetaMask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const adminAddr = await signer.getAddress();

            const msg = `Admin Access: ${adminAddr}\nVerify ownership.`;
            await signer.signMessage(msg);

            document.getElementById("connectBtn").innerText = "âœ… ç®¡ç†å‘˜å·²ç™»å½•";
            document.getElementById("connectBtn").style.background = "rgba(0, 255, 163, 0.1)";
            document.getElementById("connectBtn").style.color = "#00FFA3";

            refreshDashboard();
            setInterval(refreshDashboard, 10000); 

        } catch(e) { alert("ç™»å½•å¤±è´¥"); }
    }

    // --- æ ¸å¿ƒï¼šæ•°æ®ä¸é‡‘èè®¡ç®— ---
    async function refreshDashboard() {
        if(!provider) return;
        
        const tokenCt = new ethers.Contract(GADKK_ADDR, ABI_COMMON, provider);
        const usdtCt = new ethers.Contract(USDT_ADDR, ABI_COMMON, provider);
        const buybackCt = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, provider);

        try {
            // 1. åŸºç¡€ä½™é¢
            const lpBal = await tokenCt.balanceOf(LP_FUND_ADDR);
            document.getElementById("lpFundBalance").innerText = parseFloat(ethers.utils.formatUnits(lpBal, 18)).toFixed(2);

            const usdtBal = await usdtCt.balanceOf(BUYBACK_ADDR);
            document.getElementById("usdtBalance").innerText = parseFloat(ethers.utils.formatUnits(usdtBal, 18)).toFixed(2);

            // 2. æŠ›å‹è®¡ç®— (Spy Logic)
            const currentMarkRaw = await tokenCt.balanceOf(MARKETING_ADDR);
            const lastMarkRaw = await buybackCt.lastMarkBalance();
            
            const currentMark = parseFloat(ethers.utils.formatUnits(currentMarkRaw, 18));
            const lastMark = parseFloat(ethers.utils.formatUnits(lastMarkRaw, 18));
            
            // ç§¯å‹çš„ç¨ (Backlog)
            let taxDiff = currentMark - lastMark;
            if (taxDiff < 0) taxDiff = 0;
            document.getElementById("taxBacklog").innerText = taxDiff.toFixed(2) + " ADKK";

            // åæ¨å¸‚åœºæˆäº¤é‡ (Implied Volume) = ç¨ / ç¨ç‡
            impliedVol = taxDiff / MARKETING_TAX_RATE;
            document.getElementById("impliedVolume").innerText = impliedVol.toFixed(2) + " ADKK";

            // 3. å®æ—¶ä»·æ ¼è®¡ç®— (é€šè¿‡ LP æ± å­ä½™é¢)
            const poolAdkkRaw = await tokenCt.balanceOf(PAIR_ADDR);
            const poolUsdtRaw = await usdtCt.balanceOf(PAIR_ADDR);
            
            const poolAdkk = parseFloat(ethers.utils.formatUnits(poolAdkkRaw, 18));
            const poolUsdt = parseFloat(ethers.utils.formatUnits(poolUsdtRaw, 18));

            if(poolAdkk > 0) {
                // ä»·æ ¼ = æ± å­é‡Œçš„ USDT / æ± å­é‡Œçš„ ADKK
                currentPrice = poolUsdt / poolAdkk;
                document.getElementById("tokenPrice").innerText = currentPrice.toFixed(6);
            }

        } catch(e) { console.error("åˆ·æ–°é”™è¯¯:", e); }
    }

    // --- äº¤äº’è®¡ç®— ---
    
    // å¡«å…¥å»ºè®®å€¼ (å¡«å…¥çš„æ˜¯æŠ›å‹é‡)
    function fillRec() {
        if(impliedVol > 0) {
            document.getElementById("targetAdkk").value = impliedVol.toFixed(2);
            calculateCost(); // è§¦å‘è®¡ç®—
        }
    }

    // è¾“å…¥ ADKKï¼Œè‡ªåŠ¨ç®—å‡ºéœ€è¦å¤šå°‘ USDT
    function calculateCost() {
        const inputAdkk = parseFloat(document.getElementById("targetAdkk").value);
        if(!inputAdkk || currentPrice === 0) {
            document.getElementById("costPreview").innerText = "æ¶ˆè€—: 0.00 USDT";
            usdtCost = 0;
            return;
        }

        // ç®€å•çš„ç°è´§ä»·æ ¼è®¡ç®—: æ•°é‡ * ä»·æ ¼
        // (æ³¨ï¼šå¤§é¢äº¤æ˜“ä¼šæœ‰æ»‘ç‚¹ï¼Œè¿™é‡Œä½œä¸ºç®¡ç†å‘˜ä¼°ç®—å‚è€ƒè¶³å¤Ÿäº†)
        usdtCost = inputAdkk * currentPrice;
        document.getElementById("costPreview").innerText = `â‰ˆ æ¶ˆè€—: ${usdtCost.toFixed(4)} USDT`;
    }

    // --- æ‰§è¡Œäº¤æ˜“ ---

    async function triggerBuyback() {
        if(!signer) return alert("è¯·å…ˆç™»å½•");
        if(usdtCost <= 0) return alert("è¯·è¾“å…¥æ•°é‡å¹¶ç¡®ä¿é‡‘é¢æœ‰æ•ˆ");

        // é˜²æ­¢æ»‘ç‚¹ä¸å¤Ÿï¼Œç¨å¾®å¤šåŠ  1% çš„ USDT é¢„ç®— (å¯é€‰ï¼Œè¿™é‡Œå…ˆæŒ‰ç²¾å‡†å€¼)
        const finalUsdt = usdtCost; 

        const contract = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, signer);
        try {
            // è¿™é‡Œçš„å‚æ•°æ˜¯ USDT çš„ Wei
            const weiAmt = ethers.utils.parseUnits(finalUsdt.toFixed(18), 18);
            
            const tx = await contract.buyUSDT(weiAmt, { gasLimit: 1000000 });
            alert("ğŸ”¥ æ‹‰ç›˜æŒ‡ä»¤å·²å‘é€ï¼\nHash: " + tx.hash);
            await tx.wait();
            alert("âœ… æ‹‰ç›˜æˆåŠŸï¼");
            refreshDashboard();
            document.getElementById("targetAdkk").value = "";
            document.getElementById("costPreview").innerText = "æ¶ˆè€—: 0.00 USDT";
        } catch(e) {
            alert("âŒ å¤±è´¥: " + (e.reason || e.message));
        }
    }

    async function processLP() {
        if(!signer) return alert("è¯·å…ˆç™»å½•");
        const contract = new ethers.Contract(LP_FUND_ADDR, ABI_LP, signer);
        try {
            const tx = await contract.process({ gasLimit: 3000000 });
            alert("ğŸš€ åŠ æ± æŒ‡ä»¤å·²å‘é€ï¼");
            await tx.wait();
            alert("âœ… åŠ æ± æˆåŠŸï¼");
            refreshDashboard();
        } catch(e) { alert("å¤±è´¥: " + e.message); }
    }

</script>
</body>
</html>
