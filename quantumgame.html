<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUANTUM RESONANCE | GADKk</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --neon-green: #00FFA3; --neon-red: #FF2A6D; --neon-blue: #00C2FF; --neon-gold: #FFD700;
            --dark-bg: #050B14; --glass: rgba(15, 25, 35, 0.9); --border: rgba(255,255,255,0.15);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            background: var(--dark-bg); color: #fff; font-family: 'Rajdhani', sans-serif; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; overflow-x: hidden; 
            background-image: radial-gradient(circle at 50% 40%, #112220 0%, #000 80%); 
        }

        /* --- é¡¶éƒ¨å¯¼èˆª --- */
        .header { 
            width: 100%; padding: 20px; display: flex; justify-content: space-between; align-items: center; max-width: 600px; z-index: 100;
        }
        .logo { font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--neon-green); letter-spacing: 2px; text-shadow: 0 0 15px rgba(0,255,163,0.6); display: flex; align-items: center; gap: 8px; }
        .logo::before { content: ''; display: block; width: 10px; height: 10px; background: var(--neon-green); transform: rotate(45deg); box-shadow: 0 0 10px var(--neon-green); }

        .nav-right { display: flex; gap: 10px; align-items: center; }
        
        .icon-btn { 
            width: 36px; height: 36px; border: 1px solid var(--border); border-radius: 8px; 
            display: flex; justify-content: center; align-items: center; cursor: pointer; 
            background: rgba(255,255,255,0.05); font-weight: bold; font-family: 'Orbitron'; color: #fff;
            transition: 0.3s;
        }
        .icon-btn:hover { border-color: var(--neon-green); color: var(--neon-green); box-shadow: 0 0 15px rgba(0,255,163,0.3); }

        .wallet-btn { 
            border: 1px solid var(--neon-green); color: var(--neon-green); background: rgba(0,255,163,0.1); 
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; 
            font-family: 'Orbitron'; font-size: 12px; white-space: nowrap;
        }
        .wallet-btn:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 20px var(--neon-green); }

        .lang-switch { display: flex; background: rgba(255,255,255,0.1); border-radius: 6px; padding: 3px; }
        .lang-btn { padding: 5px 10px; font-size: 12px; cursor: pointer; color: #888; font-weight: bold; transition: 0.3s; border-radius: 4px; }
        .lang-btn.active { background: var(--neon-green); color: #000; }

        /* --- æ¸¸æˆåŒºåŸŸ (æ ¸å¿ƒå¸ƒå±€ - V3.1) --- */
        .game-container { 
            position: relative; width: 360px; height: 360px; margin: 40px auto; 
            display: flex; justify-content: center; align-items: center; 
        }

        /* ğŸ”¥ æ ¸å¿ƒååº”å † */
        .core { 
            width: 140px; height: 140px; border-radius: 50%; 
            background: radial-gradient(circle, #fff 0%, var(--neon-green) 40%, transparent 80%); 
            box-shadow: 0 0 60px var(--neon-green), inset 0 0 20px rgba(255,255,255,0.5); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 10; position: absolute; 
            animation: breathe 3s ease-in-out infinite; 
            border: 1px solid rgba(255,255,255,0.2);
        }
        .core.critical { 
            background: radial-gradient(circle, #fff 0%, var(--neon-red) 40%, transparent 80%); 
            box-shadow: 0 0 80px var(--neon-red); animation: shake 0.5s infinite; 
        }
        /* ç™½è‰²å‘å…‰å­— */
        .core-text { 
            color: #fff; font-weight: 900; font-size: 28px; font-family: 'Orbitron'; 
            z-index: 11; text-shadow: 0 2px 10px rgba(0,0,0,0.8); letter-spacing: 1px;
        }
        /* æ”¾å¤§ç‰ˆè®¡æ•°å™¨ */
        .core-count { 
            font-size: 16px; color: #fff; font-weight: bold; margin-top: 2px; z-index: 11; 
            background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 10px; font-family: 'Orbitron';
        }
        @keyframes breathe { 
            0%, 100% { transform: scale(1); opacity: 0.95; } 
            50% { transform: scale(1.05); opacity: 1; box-shadow: 0 0 80px var(--neon-green); } 
        }
        @keyframes shake { 0% { transform: translate(1px, 1px) } 25% { transform: translate(-1px, -2px) } 50% { transform: translate(-3px, 0px) } 75% { transform: translate(3px, 2px) } 100% { transform: translate(1px, -1px) } }

        /* æ§½ä½ (åº§ä½) */
        .slot { 
            position: absolute; width: 64px; height: 64px; 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 22px; color: #fff; font-weight: 700; transition: 0.3s; 
            background: rgba(20, 25, 30, 0.8); backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.6); font-family: 'Orbitron';
        }
        .slot.active { 
            border-color: var(--neon-green); background: rgba(0, 255, 163, 0.15); 
            box-shadow: 0 0 25px rgba(0, 255, 163, 0.5), inset 0 0 10px rgba(0, 255, 163, 0.2); 
            color: var(--neon-green); transform: scale(1.1); text-shadow: 0 0 10px var(--neon-green);
        }
        .slot.collapsed { 
            border-color: var(--neon-red); box-shadow: 0 0 40px var(--neon-red); 
            background: rgba(255, 42, 109, 0.4); animation: shake 0.5s; color: #fff;
        }

        /* å¸ƒå±€è®¡ç®— (è¿˜åŸå…­è¾¹å½¢) */
        .slot:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); } 
        .slot:nth-child(2) { top: 25%; right: 5%; } 
        .slot:nth-child(3) { bottom: 25%; right: 5%; } 
        .slot:nth-child(4) { bottom: 0; left: 50%; transform: translateX(-50%); } 
        .slot:nth-child(5) { bottom: 25%; left: 5%; } 
        .slot:nth-child(6) { top: 25%; left: 5%; } 

        /* --- æ§åˆ¶é¢æ¿ --- */
        .control-panel { 
            max-width: 420px; width: 90%; background: var(--glass); 
            border: 1px solid var(--border); border-radius: 20px; padding: 25px; 
            text-align: center; margin-bottom: 20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); position: relative; z-index: 20;
        }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #aaa; align-items: center; }
        .info-val { color: #fff; font-weight: bold; font-family: 'Orbitron'; letter-spacing: 1px; font-size: 16px; }

        .btn-inject { 
            width: 100%; padding: 18px; border: none; border-radius: 10px; 
            font-family: 'Orbitron'; font-size: 18px; font-weight: bold; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 1px; position: relative; overflow: hidden; transition: 0.3s; 
            margin-top: 15px;
        }
        .btn-inject.approve { background: #FFD700; color: #000; box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        .btn-inject.join { background: var(--neon-green); color: #000; box-shadow: 0 0 30px rgba(0, 255, 163, 0.5); }
        .btn-inject:disabled { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }

        /* --- å¼¹çª—ä¸é€šçŸ¥ --- */
        .toast-container { position: fixed; top: 90px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            pointer-events: auto; background: rgba(10, 15, 20, 0.95); border-left: 4px solid #fff; padding: 15px 20px; 
            border-radius: 6px; color: #fff; min-width: 240px; font-size: 14px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); transform: translateX(120%); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.1); border-left-width: 4px;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--neon-green); }
        .toast.error { border-left-color: var(--neon-red); }

        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 9999; 
            display: flex; justify-content: center; align-items: center; 
            opacity: 0; pointer-events: none; transition: 0.3s; 
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        
        .modal-box { 
            width: 85%; max-width: 380px; background: #080c11; 
            border: 1px solid var(--neon-green); box-shadow: 0 0 50px rgba(0, 255, 163, 0.15);
            border-radius: 20px; padding: 30px; text-align: center; transform: scale(0.8); transition: 0.3s;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-icon { font-size: 48px; margin-bottom: 15px; display: block; }
        
        .modal-title { font-size: 26px; font-weight: 900; margin-bottom: 20px; color: var(--neon-green); font-family: 'Orbitron'; letter-spacing: 1px; text-transform: uppercase; }
        
        .modal-content-styled { text-align: left; color: #ddd; font-size: 14px; line-height: 1.7; }
        .modal-content-styled h3 { color: var(--neon-green); font-family: 'Orbitron'; margin: 20px 0 10px 0; font-size: 18px; border-bottom: 1px solid rgba(0,255,163,0.3); padding-bottom: 5px; }
        .modal-content-styled ul { padding-left: 20px; margin-bottom: 15px; }
        .modal-content-styled li { margin-bottom: 8px; }
        .highlight { color: var(--neon-green); font-weight: bold; }
        .danger { color: var(--neon-red); font-weight: bold; }

        .modal-msg-simple { color: #ccc; font-size: 15px; margin-bottom: 25px; line-height: 1.6; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; }

        .modal-btn { 
            width: 100%; padding: 14px; background: transparent; color: var(--neon-green); 
            border: 1px solid var(--neon-green); border-radius: 8px; cursor: pointer; font-weight: bold;
            transition: 0.2s; font-family: 'Orbitron'; font-size: 14px; margin-top: 10px;
        }
        .modal-btn:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 20px var(--neon-green); }

        .modal-box.win { border-color: var(--neon-gold); box-shadow: 0 0 60px rgba(255, 215, 0, 0.2); }
        .modal-box.win .modal-title { color: var(--neon-gold); }
        .modal-box.win .modal-btn { border-color: var(--neon-gold); color: var(--neon-gold); }
        .modal-box.win .modal-btn:hover { background: var(--neon-gold); color: #000; }

        .modal-box.lose { border-color: var(--neon-red); box-shadow: 0 0 60px rgba(255, 42, 109, 0.2); }
        .modal-box.lose .modal-title { color: var(--neon-red); }
        .modal-box.lose .modal-btn { border-color: var(--neon-red); color: var(--neon-red); }
        .modal-box.lose .modal-btn:hover { background: var(--neon-red); color: #fff; }

        .loader { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(0,0,0,0.2); border-radius: 50%; border-top-color: #000; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 380px) {
            .game-container { transform: scale(0.85); margin: 20px auto; }
            .modal-box { width: 95%; padding: 20px 15px; }
            .modal-title { font-size: 22px; }
        }

    </style>
</head>
<body>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-box" id="modalBox">
        <span class="modal-icon" id="mIcon"></span>
        <div class="modal-title" id="mTitle">TITLE</div>
        <div class="modal-msg-simple" id="mMsg" style="display:none;">Message goes here...</div>
        <div class="modal-content-styled" id="mContent" style="display:none;"></div>
        <button class="modal-btn" onclick="closeModal()">CLOSE</button>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="header">
    <div class="logo">QUANTUM RESONANCE</div>
    <div class="nav-right">
        <div class="icon-btn" onclick="showRules()">?</div>
        <div class="lang-switch" style="margin: 0 10px;">
            <div class="lang-btn active" id="lang-en" onclick="setLang('en')">EN</div>
            <div class="lang-btn" id="lang-cn" onclick="setLang('cn')">CN</div>
        </div>
        <div class="wallet-btn" id="connectBtn" onclick="connectWallet()" data-i18n="btn_connect">CONNECT</div>
    </div>
</div>

<div class="game-container">
    <div class="slot" id="slot-0">1</div>
    <div class="slot" id="slot-1">2</div>
    <div class="slot" id="slot-2">3</div>
    <div class="slot" id="slot-3">4</div>
    <div class="slot" id="slot-4">5</div>
    <div class="slot" id="slot-5">6</div>
    
    <div class="core" id="core">
        <div class="core-text" id="statusText">WAIT</div>
        <div class="core-count" id="playerCount">0/6</div>
    </div>
</div>

<div class="control-panel">
    <div class="info-row">
        <span data-i18n="entry_fee">ENTRY FEE</span>
        <span class="info-val" id="entryFeeDisplay">--</span>
    </div>
    <div class="info-row">
        <span data-i18n="balance">MY BALANCE</span>
        <span class="info-val" id="myBalance">--</span>
    </div>
    <div class="info-row">
        <span data-i18n="status">STATUS</span>
        <span class="info-val" id="gameState" style="color:var(--neon-green)">STABLE</span>
    </div>

    <button class="btn-inject join" id="actionBtn" onclick="handleAction()">
        <span data-i18n="btn_connect_first">CONNECT FIRST</span>
    </button>
</div>

<script>
    // --- ğŸš¨ é…ç½®åŒºåŸŸ ---
    const TOKEN_ADDR = "0xA1aEE242C69E1c0820d165ef12438e0A5eEd0BbA"; // GADKk Token
    const GAME_ADDR  = "0x5759A32B6fFe0A998D43FF037487529aFd7c0946"; // ä½ çš„æ¸¸æˆåˆçº¦
    
    const i18n = {
        en: {
            btn_connect: "CONNECT",
            entry_fee: "TICKET PRICE",
            balance: "YOUR BALANCE",
            status: "SYSTEM STATUS",
            status_stable: "STABLE",
            status_critical: "CRITICAL",
            status_wait: "WAIT",
            btn_connect_first: "CONNECT WALLET",
            btn_approve: "UNLOCK PROTOCOL",
            btn_join: "INJECT ENERGY",
            btn_processing: "PROCESSING...",
            toast_connect: "System Online",
            toast_tx_sent: "Transmission Sent...",
            toast_success: "Success!",
            toast_error: "Error: ",
            
            rules_title: "PROTOCOL RULES",
            rules_html: `
                <h3>âš¡ Core Mechanism</h3>
                <p>6 players inject energy into the core. Once the 6th player joins, a quantum collapse occurs immediately.</p>
                
                <h3>ğŸ² Elimination</h3>
                <p>The system randomly selects 1 player to be consumed. Their entire entry fee is lost (<span class="danger">100% Loss</span>).</p>
                
                <h3>ğŸ’ Tokenomics</h3>
                <ul>
                    <li>ğŸ”¥ <span class="highlight">40% Burned:</span> Permanently removed.</li>
                    <li>ğŸ¦ <span class="highlight">10% Platform:</span> Marketing/Dev.</li>
                    <li>ğŸ’° <span class="highlight">50% Dividend:</span> Split among 5 survivors (+10% profit each).</li>
                </ul>
            `,
            
            win_title: "SURVIVOR",
            win_msg: "You survived the collapse! Rewards have been transferred to your wallet.",
            lose_title: "ELIMINATED",
            lose_msg: "Core consumed your energy. Better luck next time."
        },
        cn: {
            btn_connect: "è¿æ¥é’±åŒ…",
            entry_fee: "å…¥åœºé—¨ç¥¨",
            balance: "ä½ çš„ä½™é¢",
            status: "ç³»ç»ŸçŠ¶æ€",
            status_stable: "ç³»ç»Ÿç¨³å®š",
            status_critical: "ä¸´ç•ŒçŠ¶æ€",
            status_wait: "ç­‰å¾…ä¸­",
            btn_connect_first: "è¯·è¿æ¥é’±åŒ…",
            btn_approve: "è§£é”åè®® (æˆæƒ)",
            btn_join: "æ³¨å…¥èƒ½é‡ (åŠ å…¥)",
            btn_processing: "å¤„ç†ä¸­...",
            toast_connect: "ç³»ç»Ÿå·²è¿æ¥",
            toast_tx_sent: "äº¤æ˜“å·²å‘é€...",
            toast_success: "æ“ä½œæˆåŠŸï¼",
            toast_error: "é”™è¯¯: ",
            
            rules_title: "æ¸¸æˆè§„åˆ™ä¸èµ„é‡‘",
            rules_html: `
                <h3>âš¡ æ ¸å¿ƒæœºåˆ¶</h3>
                <p>6åç©å®¶æ³¨å…¥èƒ½é‡ã€‚å½“ç¬¬6äººåŠ å…¥æ—¶ï¼Œæ ¸å¿ƒå³åˆ»å‘ç”Ÿåå¡Œã€‚</p>
                
                <h3>ğŸ² æ·˜æ±°æœºåˆ¶</h3>
                <p>ç³»ç»Ÿéšæœºé€‰ä¸­1åç©å®¶ï¼Œå…¶æ³¨å…¥çš„èƒ½é‡å°†è¢«å®Œå…¨åå™¬ (<span class="danger">æœ¬é‡‘100%å½’é›¶</span>)ã€‚</p>
                
                <h3>ğŸ’ èµ„é‡‘åˆ†é… (Tokenomics)</h3>
                <ul>
                    <li>ğŸ”¥ <span class="highlight">40% é”€æ¯:</span> ç›´æ¥æ‰“å…¥é»‘æ´åœ°å€ã€‚</li>
                    <li>ğŸ¦ <span class="highlight">10% è¿è¥:</span> ç”¨äºå¹³å°è¥é”€ã€‚</li>
                    <li>ğŸ’° <span class="highlight">50% åˆ†çº¢:</span> 5åå¹¸å­˜è€…å¹³åˆ† (æ¯äººç«‹èµš 10% åˆ©æ¶¦)ã€‚</li>
                </ul>
            `,

            win_title: "å¹¸å­˜è€…",
            win_msg: "æ­å–œï¼ä½ åœ¨åå¡Œä¸­å¹¸å­˜ï¼Œå¥–åŠ±å·²è‡ªåŠ¨å‘é€è‡³ä½ çš„é’±åŒ…ã€‚",
            lose_title: "å·²æ·˜æ±°",
            lose_msg: "æ ¸å¿ƒåå¡Œï¼ä½ çš„èƒ½é‡è¢«åå™¬äº†ï¼Œæœ¬é‡‘å·²æŒ‰ç…§è§„åˆ™è¿›è¡Œåˆ†é…é”€æ¯ã€‚"
        }
    };

    let currentLang = localStorage.getItem('gadkk_lang') || 'cn'; 
    let provider, signer, userAddr;
    let gameContract, tokenContract;
    let entryFeeVal = ethers.BigNumber.from(0);

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'click') {
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'win') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.setValueAtTime(554, now + 0.1);
            osc.frequency.setValueAtTime(659, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
        } else if (type === 'lose') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.linearRampToValueAtTime(30, now + 0.5);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
        } else if (type === 'alert') {
            osc.frequency.setValueAtTime(800, now);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        }
    }

    window.onload = () => {
        setLang(currentLang);
    };

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('gadkk_lang', lang);
        document.getElementById('lang-cn').classList.toggle('active', lang === 'cn');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        updateTexts();
        playSound('click');
    }

    function updateTexts() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
        });
        
        const countStr = document.getElementById("playerCount").innerText;
        const count = parseInt(countStr.split('/')[0]) || 0;
        const statusText = document.getElementById("statusText");
        const gameState = document.getElementById("gameState");
        
        if (count >= 5) {
            statusText.innerText = i18n[currentLang].status_critical;
            gameState.innerText = i18n[currentLang].status_critical;
            gameState.style.color = "var(--neon-red)";
        } else {
            statusText.innerText = i18n[currentLang].status_wait;
            gameState.innerText = i18n[currentLang].status_stable;
            gameState.style.color = "var(--neon-green)";
        }

        if(userAddr) checkAllowance();
    }

    function showToast(msg, type='info') {
        const div = document.createElement('div');
        div.className = `toast ${type}`;
        const icon = type==='success'?'âœ…':(type==='error'?'âŒ':'â„¹ï¸');
        div.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
        document.getElementById('toastContainer').appendChild(div);
        setTimeout(()=>div.classList.add('show'),10);
        setTimeout(()=>{div.classList.remove('show');setTimeout(()=>div.remove(),300)},3000);
    }

    function showModal(type, title, content) {
        const overlay = document.getElementById('modalOverlay');
        const box = document.getElementById('modalBox');
        const iconEl = document.getElementById('mIcon');
        
        box.className = 'modal-box ' + type;
        
        if(type === 'win') iconEl.innerText = 'ğŸ†';
        else if(type === 'lose') iconEl.innerText = 'ğŸ’€';
        else iconEl.innerText = '';

        document.getElementById('mTitle').innerText = title;
        
        if(type === 'normal') {
            document.getElementById('mContent').innerHTML = content;
            document.getElementById('mMsg').style.display = 'none';
            document.getElementById('mContent').style.display = 'block';
        } else {
            document.getElementById('mMsg').innerText = content;
            document.getElementById('mMsg').style.display = 'block';
            document.getElementById('mContent').style.display = 'none';
        }

        overlay.classList.add('show');
        if(type !== 'normal') playSound(type);
        else playSound('alert');
    }
    
    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('show');
        playSound('click');
    }
    
    function showRules() {
        showModal('normal', i18n[currentLang].rules_title, i18n[currentLang].rules_html);
    }

    async function connectWallet() {
        if (!window.ethereum) return showToast("Please install MetaMask", "error");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddr = await signer.getAddress();
            
            document.getElementById("connectBtn").innerText = userAddr.substring(0, 6) + "...";
            
            const ABI_TOKEN = ["function approve(address,uint) external", "function allowance(address,address) view returns (uint)", "function balanceOf(address) view returns (uint)"];
            const ABI_GAME = ["function injectEnergy() external", "function getPlayers() view returns (address[])", "function entryFee() view returns (uint)", "event ResonanceCollapse(address indexed, uint, uint)"];

            tokenContract = new ethers.Contract(TOKEN_ADDR, ABI_TOKEN, signer);
            gameContract = new ethers.Contract(GAME_ADDR, ABI_GAME, signer);

            showToast(i18n[currentLang].toast_connect, "success");
            playSound('click');

            refreshData();
            listenEvents();
            setInterval(refreshData, 5000); 

        } catch(e) { console.error(e); }
    }

    async function refreshData() {
        if(!userAddr) return;
        try {
            entryFeeVal = await gameContract.entryFee();
            document.getElementById("entryFeeDisplay").innerText = parseFloat(ethers.utils.formatUnits(entryFeeVal, 18)).toLocaleString() + " GADKk";

            const bal = await tokenContract.balanceOf(userAddr);
            document.getElementById("myBalance").innerText = parseFloat(ethers.utils.formatUnits(bal, 18)).toFixed(2);

            const players = await gameContract.getPlayers();
            updateSlots(players);
            checkAllowance();

        } catch (e) {}
    }

    function updateSlots(players) {
        const count = players.length;
        document.getElementById("playerCount").innerText = `${count}/6`;
        
        const core = document.getElementById("core");
        const statusText = document.getElementById("statusText");
        const gameState = document.getElementById("gameState");

        if (count >= 5) {
            core.className = "core critical";
            statusText.innerText = i18n[currentLang].status_critical;
            gameState.innerText = i18n[currentLang].status_critical;
            gameState.style.color = "var(--neon-red)";
        } else {
            core.className = "core";
            statusText.innerText = i18n[currentLang].status_wait;
            gameState.innerText = i18n[currentLang].status_stable;
            gameState.style.color = "var(--neon-green)";
        }

        for(let i=0; i<6; i++) {
            const el = document.getElementById(`slot-${i}`);
            el.className = 'slot'; 
            el.innerText = i + 1; // é‡ç½®æ•°å­—

            if (i < count) {
                el.classList.add('active');
                el.innerText = 'âš¡';
            } else {
                el.classList.remove('active');
            }
        }
    }

    async function checkAllowance() {
        const btn = document.getElementById("actionBtn");
        if(btn.disabled) return;

        try {
            const allowed = await tokenContract.allowance(userAddr, GAME_ADDR);
            
            if (allowed.lt(entryFeeVal)) {
                btn.className = "btn-inject approve";
                btn.innerText = i18n[currentLang].btn_approve;
                btn.onclick = approveToken;
            } else {
                btn.className = "btn-inject join";
                btn.innerText = i18n[currentLang].btn_join;
                btn.onclick = inject;
            }
        } catch(e) {}
    }

    function setBtnLoading(loading) {
        const btn = document.getElementById("actionBtn");
        if(loading) {
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> ${i18n[currentLang].btn_processing}`;
        } else {
            btn.disabled = false;
            checkAllowance(); 
        }
    }

    async function handleAction() { 
        if(!userAddr) connectWallet(); 
    }

    async function approveToken() {
        setBtnLoading(true);
        try {
            const tx = await tokenContract.approve(GAME_ADDR, ethers.constants.MaxUint256);
            showToast(i18n[currentLang].toast_tx_sent);
            await tx.wait();
            showToast(i18n[currentLang].toast_success, "success");
            playSound('click');
        } catch(e) {
            showToast(i18n[currentLang].toast_error + (e.reason || e.message), "error");
        }
        setBtnLoading(false);
    }

    async function inject() {
        setBtnLoading(true);
        try {
            const tx = await gameContract.injectEnergy({ gasLimit: 500000 });
            showToast(i18n[currentLang].toast_tx_sent);
            await tx.wait();
        } catch(e) {
            showToast(i18n[currentLang].toast_error + (e.reason || e.message), "error");
        }
        setBtnLoading(false);
    }

    function listenEvents() {
        const filterJoin = { address: GAME_ADDR, topics: [ethers.utils.id("Joined(address,uint256)")] };
        provider.on(filterJoin, () => {
            refreshData();
            playSound('click');
        });

        gameContract.on("ResonanceCollapse", (loser, burned, reward) => {
            setTimeout(() => handleGameOver(loser), 2000); 
        });
    }

    function handleGameOver(loser) {
        const isLoser = (loser.toLowerCase() === userAddr.toLowerCase());
        const r = i18n[currentLang];

        if (isLoser) {
            showModal('lose', r.lose_title, r.lose_msg);
        } else {
            showModal('win', r.win_title, r.win_msg);
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#FFD700', '#00FFA3'] });
        }
        refreshData();
    }
</script>
</body>
</html>
