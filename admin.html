<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GADKk ADMIN v8.0 (Auto Pilot)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- æ ·å¼åŒºåŸŸ (é»‘å®¢é£æ ¼) --- */
        * { box-sizing: border-box; } body { background-color: #050505; background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 70%); color: #fff; font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; } .container { width: 100%; max-width: 500px; position: relative; z-index: 10; } .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #222; padding-bottom: 20px; } h1 { margin: 0; font-family: 'Rajdhani', sans-serif; letter-spacing: 4px; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2); } .version-tag { background: linear-gradient(90deg, #FF9900, #FF4500); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 12px; vertical-align: middle; margin-left: 10px; font-weight: bold; } .card { background: rgba(20, 20, 20, 0.6); border: 1px solid #333; backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); } .card-header { display: flex; justify-content: space-between; align-items: center; color: #888; font-size: 13px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 10px; } .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; } .big-num { font-size: 32px; font-weight: bold; font-family: 'Rajdhani', sans-serif; color: #00FFA3; text-shadow: 0 0 10px rgba(0, 255, 163, 0.3); } .unit { font-size: 14px; color: #666; margin-left: 4px; } .spy-dashboard { background: #0f0f0f; border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px; } .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #222; } .data-row:last-child { border: none; margin: 0; padding: 0; } .data-label { color: #888; font-size: 13px; display: flex; align-items: center; gap: 5px; } .data-val { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 18px; color: #eee; } .highlight-val { color: #FF4500; font-size: 22px; text-shadow: 0 0 10px rgba(255, 69, 0, 0.3); } .input-wrapper { position: relative; background: #111; border: 1px solid #444; border-radius: 8px; display: flex; align-items: center; padding: 0 15px; transition: 0.3s; margin-bottom: 15px; } .input-wrapper:focus-within { border-color: #FF4500; box-shadow: 0 0 10px rgba(255, 69, 0, 0.2); } .input-wrapper input { width: 100%; background: none; border: none; color: #fff; font-size: 18px; padding: 16px 0; font-family: 'Rajdhani', sans-serif; outline: none; } .input-suffix { color: #666; font-size: 12px; white-space: nowrap; } .auto-fill-btn { color: #00FFA3; font-size: 12px; cursor: pointer; text-decoration: underline; margin-left: 10px; } .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; font-family: 'Rajdhani', sans-serif; letter-spacing: 1px; transition: all 0.2s; position: relative; overflow: hidden; } .btn:active { transform: scale(0.98); } .btn-connect { background: #222; color: #ccc; border: 1px solid #444; margin-bottom: 20px; } .btn-green { background: linear-gradient(135deg, #00FFA3, #008cff); color: #000; box-shadow: 0 4px 15px rgba(0, 255, 163, 0.3); } .btn-red { background: linear-gradient(135deg, #FF4500, #ff0055); color: #fff; box-shadow: 0 4px 15px rgba(255, 69, 0, 0.3); } .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; } .toast { pointer-events: auto; background: rgba(20, 20, 20, 0.95); border-left: 4px solid; padding: 15px 20px; border-radius: 4px; color: #fff; min-width: 300px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); font-size: 14px; } .toast.show { transform: translateX(0); } .toast-success { border-color: #00FFA3; } .toast-error { border-color: #FF4500; } .toast-info { border-color: #00C2FF; } .toast-icon { margin-right: 10px; font-size: 18px; }
        
        /* è®¾ç½®åŒºåŸŸ */
        .settings-bar { font-size: 12px; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #333; display: flex; justify-content: space-between; align-items: center; }
        .addr-display { font-family: monospace; color: #888; }
        .edit-link { color: #00FFA3; cursor: pointer; text-decoration: none; }
    </style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>
<div class="container">
    <div class="header">
        <h1>GADKk ADMIN <span class="version-tag">v8.0</span></h1>
        <div style="font-size:12px; color:#555; margin-top:5px;">AUTO PILOT SYSTEM</div>
    </div>
    <button id="connectBtn" class="btn btn-connect" onclick="connectWallet()">ğŸ”‘ éªŒè¯ç®¡ç†å‘˜èº«ä»½ (Verify)</button>

    <div class="card">
        <div class="card-header">
            <span>ğŸ›¡ï¸ LP FUND (è‡ªåŠ¨å›æµ)</span>
            <span style="color:#00FFA3"><span class="dot" style="background:#00FFA3"></span>Running</span>
        </div>
        <div class="big-num"><span id="lpFundBalance">--</span><span class="unit">ADKK</span></div>
        <button class="btn btn-green" onclick="processLP()">âš¡ æ‰§è¡ŒåŠ æ±  (PROCESS)</button>
    </div>

    <div class="card" style="border-color: rgba(255, 69, 0, 0.3);">
        <div class="card-header">
            <span>ğŸš€ BUYBACK (ä¸€é”®è‡ªåŠ¨ç‰ˆ)</span>
            <span style="color:#FF4500"><span class="dot" style="background:#FF4500"></span>Ready</span>
        </div>
        <div class="spy-dashboard">
            <div class="data-row"><div class="data-label">ğŸ¦ è¥é”€é’±åŒ…çœŸå®ä½™é¢</div><div class="data-val" id="marketingBal">0.00</div></div>
            <div class="data-row"><div class="data-label">âœ… é“¾ä¸Šå·²å›è´­æ€»æ•°</div><div class="data-val" id="processedBal" style="color:#888">0.00</div></div>
            <div class="data-row"><div class="data-label">ğŸ“‰ å¾…å¤„ç†ç§¯å‹ (Backlog)</div><div class="data-val" style="color: #FFD700" id="ledgerBacklog">0.00</div></div>
            <div class="data-row"><div class="data-label">âš ï¸ å‰©ä½™å¸‚åœºæŠ›å‹ (Volume)</div><div class="data-val highlight-val" id="marketVolume">0.00</div></div>
            <div style="text-align: right; font-size: 12px; margin-top: 5px;"><span class="auto-fill-btn" onclick="fillBacklog()">[å¡«å…¥å…¨éƒ¨ç§¯å‹]</span></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#888; margin-bottom:5px;">
            <span>USDT é‡‘åº“: <span id="usdtBalance" style="color:#fff">--</span></span>
            <span>å½“å‰å¸ä»·: <span id="tokenPrice" style="color:#00C2FF">Calculating...</span></span>
        </div>
        <div class="input-wrapper">
            <input type="number" id="targetAdkk" placeholder="è¾“å…¥è¦ä¹°å…¥çš„ ADKK æ•°é‡" oninput="calculateCost()">
            <span class="input-suffix">ADKK</span>
        </div>
        <div style="text-align:right; font-size:12px; color:#FF4500; margin-bottom:15px; height: 16px;"><span id="costPreview"></span></div>

        <button class="btn btn-red" onclick="triggerBuyback()">ğŸ”¥ ä¸€é”®æ‹‰ç›˜ (AUTO BUY)</button>

        <div class="settings-bar">
            <span>å½“å‰æ¥æ”¶æ–¹: <span id="currentReceiver" class="addr-display">è¯»å–ä¸­...</span></span>
            <span class="edit-link" onclick="changeReceiver()">[ä¿®æ”¹]</span>
        </div>
    </div>
</div>

<script>
    // --- âœ… ä½ çš„æ–°åˆçº¦åœ°å€ (å·²é…ç½®å¥½) ---
    const BUYBACK_ADDR  = "0xa09e77ed31810b6Ec99b39f0E137c83450Fc8127"; 

    // å…¶ä»–é…ç½®
    const GADKK_ADDR    = "0xA1aEE242C69E1c0820d165ef12438e0A5eEd0BbA"; 
    const LP_FUND_ADDR  = "0xD7bB38219D069dfDD4F09Fdf568493A4B7d7E4fd"; 
    const MARKETING_ADDR= "0x2DBE6300514C4D0Cd7456348512370D3A68d4c1E"; 
    const USDT_ADDR     = "0x55d398326f99059fF775485246999027B3197955"; 
    const PAIR_ADDR     = "0x5B06dc147F363aa0111549fb5EA992A40feda6fC"; 
    const MARKETING_TAX_RATE = 0.05; 

    // ABI é…ç½®
    const ABI_COMMON = ["function balanceOf(address) view returns (uint256)"];
    const ABI_LP     = ["function process() external"]; 
    const ABI_BUY    = [
        "function buyAndAutoSend(uint256 usdtAmount, uint256 backlogReduced) external", 
        "function totalProcessedBacklog() view returns (uint256)",
        "function receiver() view returns (address)",
        "function setReceiver(address) external"
    ]; 

    let provider, signer;
    let currentPrice = 0, backlog = 0, usdtCost = 0; 

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        let icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
        toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 4000);
    }

    async function connectWallet() {
        if (!window.ethereum) return showToast("è¯·å®‰è£… MetaMask", 'error');
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const adminAddr = await signer.getAddress();
            await signer.signMessage(`Admin Verify: ${adminAddr}`);
            document.getElementById("connectBtn").innerText = "âœ… ç®¡ç†å‘˜å·²ç™»å½•";
            document.getElementById("connectBtn").style.border = "1px solid #00FFA3";
            document.getElementById("connectBtn").style.color = "#00FFA3";
            showToast("ç³»ç»Ÿå°±ç»ª", "success");
            refreshDashboard();
            setInterval(refreshDashboard, 8000); 
        } catch(e) { showToast("ç™»å½•å–æ¶ˆ", "error"); }
    }

    async function refreshDashboard() {
        if(!provider) return;
        const tokenCt = new ethers.Contract(GADKK_ADDR, ABI_COMMON, provider);
        const usdtCt = new ethers.Contract(USDT_ADDR, ABI_COMMON, provider);
        const buybackCt = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, provider);

        try {
            const lpBal = await tokenCt.balanceOf(LP_FUND_ADDR);
            document.getElementById("lpFundBalance").innerText = parseFloat(ethers.utils.formatUnits(lpBal, 18)).toFixed(2);
            
            const usdtBal = await usdtCt.balanceOf(BUYBACK_ADDR);
            document.getElementById("usdtBalance").innerText = parseFloat(ethers.utils.formatUnits(usdtBal, 18)).toFixed(2);

            const poolAdkk = parseFloat(ethers.utils.formatUnits(await tokenCt.balanceOf(PAIR_ADDR), 18));
            const poolUsdt = parseFloat(ethers.utils.formatUnits(await usdtCt.balanceOf(PAIR_ADDR), 18));
            if(poolAdkk > 0) {
                currentPrice = poolUsdt / poolAdkk;
                document.getElementById("tokenPrice").innerText = currentPrice.toFixed(6) + " U";
            }

            const realMark = parseFloat(ethers.utils.formatUnits(await tokenCt.balanceOf(MARKETING_ADDR), 18));
            document.getElementById("marketingBal").innerText = realMark.toFixed(2);

            const processed = parseFloat(ethers.utils.formatUnits(await buybackCt.totalProcessedBacklog(), 18));
            document.getElementById("processedBal").innerText = processed.toFixed(2);

            backlog = realMark - processed;
            if(backlog < 0) backlog = 0;
            document.getElementById("ledgerBacklog").innerText = backlog.toFixed(2);
            document.getElementById("marketVolume").innerText = (backlog / MARKETING_TAX_RATE).toFixed(2);

            const receiver = await buybackCt.receiver();
            const shortAddr = receiver.substring(0,6) + "..." + receiver.substring(38);
            document.getElementById("currentReceiver").innerText = shortAddr;
            if(receiver.toLowerCase().includes("dead")) {
                document.getElementById("currentReceiver").innerText = "ğŸ”¥ é»‘æ´ (è‡ªåŠ¨é”€æ¯)";
                document.getElementById("currentReceiver").style.color = "#FF4500";
            }
        } catch(e) { console.error(e); }
    }

    function calculateCost() {
        const inputAdkk = parseFloat(document.getElementById("targetAdkk").value);
        if(!inputAdkk || currentPrice === 0) {
            document.getElementById("costPreview").innerText = "";
            usdtCost = 0;
            return;
        }
        usdtCost = inputAdkk * currentPrice;
        document.getElementById("costPreview").innerText = `â‰ˆ é¢„è®¡æ¶ˆè€—: ${usdtCost.toFixed(4)} USDT`;
    }

    function fillBacklog() {
        if(backlog > 0) {
            document.getElementById("targetAdkk").value = backlog.toFixed(2);
            calculateCost();
        }
    }

    async function triggerBuyback() {
        if(!signer) return showToast("è¯·å…ˆç™»å½•", "error");
        const inputVal = parseFloat(document.getElementById("targetAdkk").value);
        if(!inputVal || inputVal <= 0) return showToast("è¯·è¾“å…¥æ•°é‡", "error");

        const contract = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, signer);
        try {
            showToast("æ­£åœ¨æ‰§è¡Œè‡ªåŠ¨æ‹‰ç›˜...", "info");
            const usdtWei = ethers.utils.parseUnits(usdtCost.toFixed(18), 18);
            const backlogWei = ethers.utils.parseUnits(inputVal.toFixed(18), 18);
            const tx = await contract.buyAndAutoSend(usdtWei, backlogWei, { gasLimit: 1000000 });
            showToast(`äº¤æ˜“å·²å‘é€!`, "info");
            await tx.wait();
            showToast("ğŸš€ æ‹‰ç›˜æˆåŠŸï¼èµ„é‡‘å·²è‡ªåŠ¨å‘é€ã€‚", "success");
            document.getElementById("targetAdkk").value = "";
            document.getElementById("costPreview").innerText = "";
            refreshDashboard();
        } catch(e) { showToast("å¤±è´¥: " + (e.reason || e.message), "error"); }
    }

    async function changeReceiver() {
        if(!signer) return showToast("è¯·å…ˆç™»å½•", "error");
        const newAddr = prompt("è¯·è¾“å…¥æ–°çš„æ¥æ”¶åœ°å€ (ç•™ç©ºåˆ™å–æ¶ˆ):");
        if(!newAddr) return;
        if(!ethers.utils.isAddress(newAddr)) return showToast("åœ°å€æ— æ•ˆ", "error");
        
        const contract = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, signer);
        try {
            showToast("æ­£åœ¨æ›´æ–°æ¥æ”¶åœ°å€...", "info");
            const tx = await contract.setReceiver(newAddr);
            await tx.wait();
            showToast("âœ… åœ°å€å·²æ›´æ–°ï¼", "success");
            refreshDashboard();
        } catch(e) { showToast("æ›´æ–°å¤±è´¥: " + e.message, "error"); }
    }

    async function processLP() {
        if(!signer) return showToast("è¯·å…ˆç™»å½•", "error");
        const contract = new ethers.Contract(LP_FUND_ADDR, ABI_LP, signer);
        try {
            showToast("æ‰§è¡Œä¸­...", "info");
            const tx = await contract.process({ gasLimit: 3000000 });
            await tx.wait();
            showToast("âœ… åŠ æ± æˆåŠŸï¼", "success");
            refreshDashboard();
        } catch(e) { showToast("å¤±è´¥: " + e.message, "error"); }
    }
</script>
</body>
</html>
