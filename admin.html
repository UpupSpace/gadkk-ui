<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GADKk ADMIN v11.0 (Flagship)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒå˜é‡ä¸é‡ç½® --- */
        :root { --primary: #00FFA3; --secondary: #00C2FF; --danger: #FF4500; --dark: #050505; --card-bg: rgba(20, 20, 25, 0.7); --glass: blur(20px); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--dark); background-image: radial-gradient(circle at 50% -20%, #1a1a2e 0%, #000000 100%); color: #fff; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; margin: 0; }
        .container { width: 100%; max-width: 480px; position: relative; z-index: 10; animation: fadeIn 0.8s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- å¤´éƒ¨ --- */
        .header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; font-family: 'Rajdhani', sans-serif; letter-spacing: 2px; font-size: 28px; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .badge { background: linear-gradient(90deg, var(--secondary), var(--primary)); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 800; vertical-align: middle; margin-left: 8px; }

        /* --- å¡ç‰‡é€šç”¨ --- */
        .card { background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: var(--glass); border-radius: 20px; padding: 24px; margin-bottom: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); transition: transform 0.3s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; box-shadow: 0 0 8px currentColor; }

        /* --- ä»ªè¡¨ç›˜æ•°æ® --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-label { font-size: 11px; color: #666; margin-bottom: 4px; }
        .stat-val { font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: 700; color: #eee; }
        .stat-val.highlight { color: var(--danger); text-shadow: 0 0 15px rgba(255, 69, 0, 0.3); }

        /* --- è¾“å…¥ä¸æŒ‰é’® --- */
        .mode-tabs { display: flex; background: rgba(0,0,0,0.4); padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; text-align: center; font-size: 13px; color: #666; cursor: pointer; border-radius: 8px; transition: 0.3s; font-weight: 600; }
        .tab-btn.active { background: rgba(255,255,255,0.1); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .tab-btn.active.mode-buy { color: var(--secondary); }
        .tab-btn.active.mode-burn { color: var(--danger); }

        .input-group { position: relative; margin-bottom: 15px; }
        .input-box { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 16px; border-radius: 12px; color: #fff; font-size: 18px; font-family: 'Rajdhani', sans-serif; outline: none; transition: 0.3s; }
        .input-box:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
        .suffix { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #666; font-size: 12px; font-weight: bold; }
        
        .helper-text { display: flex; justify-content: space-between; font-size: 12px; margin-top: 8px; color: #555; }
        .action-link { cursor: pointer; text-decoration: underline; transition: 0.2s; }
        .action-link:hover { color: #fff; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; position: relative; overflow: hidden; margin-top: 10px; }
        .btn:active { transform: scale(0.98); }
        .btn-connect { background: rgba(255,255,255,0.05); color: #aaa; border: 1px solid rgba(255,255,255,0.1); }
        .btn-green { background: linear-gradient(135deg, #00FFA3, #00C2FF); color: #000; box-shadow: 0 5px 20px rgba(0, 255, 163, 0.3); }
        .btn-red { background: linear-gradient(135deg, #FF4500, #C21500); color: #fff; box-shadow: 0 5px 20px rgba(255, 69, 0, 0.3); }

        /* --- Toast é€šçŸ¥ --- */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(15, 15, 20, 0.95); backdrop-filter: blur(10px); border-left: 4px solid; padding: 16px 20px; border-radius: 4px; color: #fff; min-width: 280px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; transform: translateX(120%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 13px; }
        .toast.show { transform: translateX(0); }
        .toast-icon { font-size: 18px; margin-right: 12px; }
        .toast-success { border-color: var(--primary); } .toast-error { border-color: var(--danger); } .toast-info { border-color: var(--secondary); }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div class="container">
    <div class="header">
        <h1>GADKk ADMIN <span class="badge">PRO v11</span></h1>
        <div style="font-size:12px; color:#555; margin-top:5px;">FINANCIAL COMMAND CENTER</div>
    </div>

    <button id="connectBtn" class="btn btn-connect" onclick="connectWallet()">ğŸ”‘ ç‚¹å‡»éªŒè¯ç®¡ç†å‘˜èº«ä»½</button>

    <div class="card">
        <div class="card-header">
            <span>ğŸ›¡ï¸ è‡ªåŠ¨å›æµ (LP Fund)</span>
            <span style="color:var(--primary)"><span class="status-dot" style="color:var(--primary)"></span>Active</span>
        </div>
        <div class="dashboard-grid" style="grid-template-columns: 1fr; margin-bottom: 10px;">
            <div class="stat-box">
                <div class="stat-label">å¾…åŠ æ± ä»£å¸ (Accumulated)</div>
                <div class="stat-val" style="color:var(--primary)" id="lpFundBalance">--</div>
            </div>
        </div>
        <button class="btn btn-green" onclick="processLP()">âš¡ æ‰§è¡ŒåŠ æ±  (PROCESS)</button>
    </div>

    <div class="card" style="border-color: rgba(255, 69, 0, 0.2);">
        <div class="card-header">
            <span>ğŸš€ æ™ºèƒ½å›è´­ (Auto Buyback)</span>
            <span style="color:var(--danger)"><span class="status-dot" style="color:var(--danger)"></span>Ready</span>
        </div>

        <div class="dashboard-grid">
            <div class="stat-box">
                <div class="stat-label">ğŸ¦ è¥é”€é’±åŒ…ä½™é¢</div>
                <div class="stat-val" id="marketingBal">0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">âš ï¸ å¸‚åœºæŠ›å‹ä¼°ç®—</div>
                <div class="stat-val highlight" id="marketVolume">0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ğŸ“‰ å¾…å¤„ç†ç§¯å‹</div>
                <div class="stat-val" style="color:#FFD700" id="ledgerBacklog">0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ğŸ’° USDT é‡‘åº“</div>
                <div class="stat-val" id="usdtBalance">--</div>
            </div>
        </div>

        <div class="mode-tabs">
            <div class="tab-btn active mode-buy" id="tab-usdt" onclick="switchMode('usdt')">æŒ‰é‡‘é¢ä¹° (USDT)</div>
            <div class="tab-btn" id="tab-adkk" onclick="switchMode('adkk')">æŒ‰æ•°é‡ä¹° (ADKK)</div>
        </div>

        <div id="mode-usdt" class="mode-section">
            <div class="input-group">
                <input type="number" class="input-box" id="inputUSDT" placeholder="0.00" oninput="calcFromUSDT()">
                <span class="suffix">USDT</span>
            </div>
            <div class="helper-text">
                <span class="action-link" style="color:var(--secondary)" onclick="fillMaxUSDT()">[æœ€å¤§ä½™é¢]</span>
                <span id="previewFromUSDT" style="color:var(--secondary)">â‰ˆ 0.00 ADKK</span>
            </div>
            <button class="btn" style="background: var(--secondary); color:#000" onclick="buyByUSDT()">ğŸ”µ ç¡®è®¤ä¹°å…¥ (BUY)</button>
        </div>

        <div id="mode-adkk" class="mode-section hidden">
            <div class="input-group">
                <input type="number" class="input-box" id="inputADKK" placeholder="0.00" oninput="calcFromADKK()">
                <span class="suffix">ADKK</span>
            </div>
            <div class="helper-text">
                <div style="display:flex; gap:10px;">
                    <span class="action-link" style="color:#FFD700" onclick="fillBacklog()">[ç§¯å‹]</span>
                    <span class="action-link" style="color:var(--danger)" onclick="fillVolume()">[æŠ›å‹]</span>
                </div>
                <span id="previewFromADKK" style="color:var(--danger)">â‰ˆ 0.00 USDT</span>
            </div>
            <button class="btn btn-red" onclick="buyByADKK()">ğŸ”¥ å¼ºåŠ›æ‹‰ç›˜ (PULL)</button>
        </div>

    </div>
</div>

<script>
    // --- ğŸš¨ é…ç½®åŒº ---
    const BUYBACK_ADDR  = "0xa09e77ed31810b6Ec99b39f0E137c83450Fc8127"; 
    const GADKK_ADDR    = "0xA1aEE242C69E1c0820d165ef12438e0A5eEd0BbA"; 
    const LP_FUND_ADDR  = "0xD7bB38219D069dfDD4F09Fdf568493A4B7d7E4fd"; 
    const MARKETING_ADDR= "0x2DBE6300514C4D0Cd7456348512370D3A68d4c1E"; 
    const USDT_ADDR     = "0x55d398326f99059fF775485246999027B3197955"; 
    const PAIR_ADDR     = "0x5B06dc147F363aa0111549fb5EA992A40feda6fC"; 
    const MARKETING_TAX_RATE = 0.05; 

    // ABI
    const ABI_COMMON = ["function balanceOf(address) view returns (uint256)"];
    const ABI_LP = ["function process() external"];
    const ABI_BUY = ["function buyAndAutoSend(uint256 usdtAmount, uint256 backlogReduced) external", "function totalProcessedBacklog() view returns (uint256)"];

    let provider, signer, currentPrice = 0, backlog = 0, volume = 0, vaultBalance = 0;

    // --- UI äº¤äº’ ---
    function showToast(msg, type='info') {
        const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
        const div = document.createElement('div');
        div.className = `toast toast-${type}`;
        div.innerHTML = `<span class="toast-icon">${icons[type]}</span><span>${msg}</span>`;
        document.getElementById('toastContainer').appendChild(div);
        setTimeout(() => div.classList.add('show'), 10);
        setTimeout(() => { div.classList.remove('show'); setTimeout(() => div.remove(), 400); }, 3000);
    }

    function switchMode(mode) {
        document.getElementById('mode-usdt').classList.add('hidden');
        document.getElementById('mode-adkk').classList.add('hidden');
        document.getElementById('tab-usdt').classList.remove('active', 'mode-buy');
        document.getElementById('tab-adkk').classList.remove('active', 'mode-burn');
        
        document.getElementById(`mode-${mode}`).classList.remove('hidden');
        const btn = document.getElementById(`tab-${mode}`);
        btn.classList.add('active');
        if(mode === 'usdt') btn.classList.add('mode-buy');
        if(mode === 'adkk') btn.classList.add('mode-burn');
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    async function connectWallet() {
        if(!window.ethereum) return showToast("è¯·å®‰è£… MetaMask", "error");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const addr = await signer.getAddress();
            // ç­¾åå¯ä»¥å¢åŠ ä»ªå¼æ„Ÿï¼Œä¹Ÿå¯ä»¥å»æ‰
            document.getElementById("connectBtn").innerText = `âœ… å·²è¿æ¥: ${addr.substring(0,6)}...`;
            document.getElementById("connectBtn").style.borderColor = "#00FFA3";
            document.getElementById("connectBtn").style.color = "#00FFA3";
            showToast("ç³»ç»Ÿè¿æ¥æˆåŠŸ", "success");
            refreshData();
            setInterval(refreshData, 10000);
        } catch(e) { showToast("è¿æ¥å–æ¶ˆ", "info"); }
    }

    async function refreshData() {
        if(!provider) return;
        const tkCt = new ethers.Contract(GADKK_ADDR, ABI_COMMON, provider);
        const usdtCt = new ethers.Contract(USDT_ADDR, ABI_COMMON, provider);
        const buyCt = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, provider);

        try {
            // åŸºç¡€æ•°æ®
            const lpVal = await tkCt.balanceOf(LP_FUND_ADDR);
            document.getElementById("lpFundBalance").innerText = parseFloat(ethers.utils.formatUnits(lpVal, 18)).toFixed(2);
            
            const usdtVal = await usdtCt.balanceOf(BUYBACK_ADDR);
            vaultBalance = parseFloat(ethers.utils.formatUnits(usdtVal, 18));
            document.getElementById("usdtBalance").innerText = vaultBalance.toFixed(2);

            // ä»·æ ¼
            const pAdkk = parseFloat(ethers.utils.formatUnits(await tkCt.balanceOf(PAIR_ADDR), 18));
            const pUsdt = parseFloat(ethers.utils.formatUnits(await usdtCt.balanceOf(PAIR_ADDR), 18));
            if(pAdkk > 0) currentPrice = pUsdt / pAdkk;

            // è´¦æœ¬è®¡ç®—
            const realMark = parseFloat(ethers.utils.formatUnits(await tkCt.balanceOf(MARKETING_ADDR), 18));
            document.getElementById("marketingBal").innerText = realMark.toFixed(2);
            
            const processed = parseFloat(ethers.utils.formatUnits(await buyCt.totalProcessedBacklog(), 18));
            backlog = Math.max(0, realMark - processed);
            document.getElementById("ledgerBacklog").innerText = backlog.toFixed(2);
            
            volume = backlog / MARKETING_TAX_RATE;
            document.getElementById("marketVolume").innerText = volume.toFixed(2);

        } catch(e) { console.error(e); }
    }

    // --- è®¡ç®—ä¸å¡«å…… ---
    function calcFromUSDT() {
        const val = parseFloat(document.getElementById("inputUSDT").value || 0);
        if(currentPrice > 0) document.getElementById("previewFromUSDT").innerText = `â‰ˆ ${(val/currentPrice).toFixed(2)} ADKK`;
    }
    function calcFromADKK() {
        const val = parseFloat(document.getElementById("inputADKK").value || 0);
        const cost = val * currentPrice;
        const el = document.getElementById("previewFromADKK");
        el.innerText = `â‰ˆ ${cost.toFixed(4)} USDT`;
        el.style.color = cost > vaultBalance ? '#FF4500' : 'var(--secondary)';
        if(cost > vaultBalance) el.innerText += " (ä½™é¢ä¸è¶³)";
    }
    
    function fillMaxUSDT() { document.getElementById("inputUSDT").value = vaultBalance; calcFromUSDT(); }
    function fillBacklog() { document.getElementById("inputADKK").value = backlog.toFixed(2); calcFromADKK(); }
    function fillVolume() { document.getElementById("inputADKK").value = volume.toFixed(2); calcFromADKK(); }

    // --- äº¤æ˜“æ‰§è¡Œ ---
    async function executeBuy(usdtAmt, adkkAmt) {
        if(!signer) return showToast("è¯·å…ˆè¿æ¥é’±åŒ…", "error");
        const ct = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, signer);
        try {
            showToast("æ­£åœ¨å‘é€äº¤æ˜“...", "info");
            // è®°è´¦é€»è¾‘ï¼šä¸èƒ½è¶…è¿‡å®é™…ç§¯å‹
            const recordAmt = adkkAmt > backlog ? backlog : adkkAmt;
            
            const tx = await ct.buyAndAutoSend(
                ethers.utils.parseUnits(usdtAmt.toFixed(18), 18),
                ethers.utils.parseUnits(recordAmt.toFixed(18), 18),
                { gasLimit: 1000000 }
            );
            showToast("äº¤æ˜“å·²å‘é€", "info");
            await tx.wait();
            showToast("ğŸš€ æ‹‰ç›˜æˆåŠŸï¼", "success");
            document.getElementById("inputUSDT").value = "";
            document.getElementById("inputADKK").value = "";
            refreshData();
        } catch(e) { showToast(e.reason || e.message, "error"); }
    }

    function buyByUSDT() {
        const val = parseFloat(document.getElementById("inputUSDT").value);
        if(!val || val <= 0) return showToast("è¾“å…¥æ— æ•ˆ", "error");
        if(val > vaultBalance) return showToast("ä½™é¢ä¸è¶³", "error");
        executeBuy(val, val / currentPrice);
    }

    function buyByADKK() {
        const val = parseFloat(document.getElementById("inputADKK").value);
        if(!val || val <= 0) return showToast("è¾“å…¥æ— æ•ˆ", "error");
        const cost = val * currentPrice;
        if(cost > vaultBalance) return showToast("é‡‘åº“ä½™é¢ä¸è¶³", "error");
        executeBuy(cost, val);
    }

    async function processLP() {
        if(!signer) return showToast("è¯·å…ˆç™»å½•", "error");
        const ct = new ethers.Contract(LP_FUND_ADDR, ABI_LP, signer);
        try {
            showToast("æ­£åœ¨åŠ æ± ...", "info");
            const tx = await ct.process({ gasLimit: 3000000 });
            await tx.wait();
            showToast("âœ… åŠ æ± æˆåŠŸ", "success");
            refreshData();
        } catch(e) { showToast(e.message, "error"); }
    }
</script>
</body>
</html>
