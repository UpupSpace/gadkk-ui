<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GADKk ADMIN v3.0 (Final)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- é»‘å®¢é£æ ¼ UI (v3.0 å¢å¼ºç‰ˆ) --- */
        * { box-sizing: border-box; }
        body { background-color: #050505; background-image: linear-gradient(rgba(0, 255, 163, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 163, 0.03) 1px, transparent 1px); background-size: 40px 40px; color: #fff; font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 500px; }
        
        .header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; font-family: 'Rajdhani', sans-serif; letter-spacing: 4px; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .version-tag { background: #333; color: #00FFA3; padding: 2px 6px; border-radius: 4px; font-size: 12px; vertical-align: middle; margin-left: 10px; }
        .subtitle { font-size: 12px; color: #666; letter-spacing: 2px; margin-top: 5px; }

        .card { background: rgba(20, 20, 20, 0.9); border: 1px solid #333; backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .card-green::before { background: #00FFA3; }
        .card-red::before { background: #FF4500; }

        .card-header { display: flex; justify-content: space-between; align-items: center; color: #aaa; font-size: 13px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 5px currentColor; }

        .big-num { font-size: 36px; font-weight: bold; margin: 10px 0; font-family: 'Rajdhani', sans-serif; display: flex; align-items: baseline; }
        .unit { font-size: 16px; color: #666; font-weight: normal; margin-left: 5px; }

        .spy-box { background: rgba(0, 0, 0, 0.3); border: 1px dashed #444; border-radius: 10px; padding: 15px; margin: 15px 0; text-align: center; }
        .spy-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .spy-val { font-size: 24px; color: #FFD700; font-family: 'Rajdhani', sans-serif; font-weight: bold; }
        .spy-tip { font-size: 12px; color: #555; margin-top: 5px; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; letter-spacing: 1px; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
        .btn:active { transform: scale(0.98); }
        .btn-connect { background: #333; color: #fff; border: 1px solid #555; margin-bottom: 20px; }
        .btn-green { background: linear-gradient(90deg, #00FFA3, #00C2FF); color: #000; box-shadow: 0 0 20px rgba(0, 255, 163, 0.2); }
        .btn-red { background: linear-gradient(90deg, #FF4500, #FF0055); color: #fff; box-shadow: 0 0 20px rgba(255, 69, 0, 0.2); }
        .btn-fill { padding: 8px 12px; background: #333; color: #00FFA3; border: 1px solid #00FFA3; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 10px; }

        .input-group { display: flex; align-items: center; background: #111; border: 1px solid #333; border-radius: 8px; padding: 5px 10px; margin-bottom: 15px; }
        .input-group input { flex: 1; background: transparent; border: none; color: #fff; font-size: 18px; padding: 10px; font-family: 'Rajdhani', sans-serif; outline: none; }
        .input-label { color: #555; font-size: 14px; margin-right: 5px; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>GADKk ADMIN <span class="version-tag">v3.0</span></h1>
        <div class="subtitle">System Control Center</div>
    </div>

    <button id="connectBtn" class="btn btn-connect" onclick="connectWallet()">ğŸ”‘ ç‚¹å‡»è¿æ¥ç®¡ç†å‘˜ (Login)</button>

    <div class="card card-green">
        <div class="card-header">
            <span>ğŸ›¡ï¸ è‡ªåŠ¨å›æµåŸºé‡‘ (LP Fund)</span>
            <span style="color: #00FFA3"><span class="status-dot"></span>Active</span>
        </div>
        <div style="font-size:12px; color:#888;">å¾…åŠ æ± ä»£å¸ (Accumulated ADKK):</div>
        <div class="big-num" style="color: #00FFA3">
            <span id="lpFundBalance">--</span>
            <span class="unit">ADKK</span>
        </div>
        <button class="btn btn-green" onclick="processLP()">âš¡ æ‰§è¡Œå›æµåŠ æ±  (PROCESS)</button>
    </div>

    <div class="card card-red">
        <div class="card-header">
            <span>ğŸš€ æ™ºèƒ½å›è´­ (Buyback V5)</span>
            <span style="color: #FF4500"><span class="status-dot"></span>Ready</span>
        </div>
        
        <div class="spy-box">
            <div class="spy-label">âš ï¸ å¸‚åœºæ½œåœ¨æŠ›å‹ (Selling Pressure)</div>
            <div class="spy-val" id="pressureVal">0.00</div>
            <div class="spy-tip" id="costTip">å»ºè®®å›è´­é‡‘é¢: è®¡ç®—ä¸­...</div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:12px; color:#888;">
            <span>é‡‘åº“ä½™é¢: <span id="usdtBalance" style="color:#fff">--</span> USDT</span>
            <span class="btn-fill" onclick="fillMax()">å…¨éƒ¨</span>
        </div>

        <div class="input-group">
            <span class="input-label">Amount:</span>
            <input type="number" id="buyInput" placeholder="è¾“å…¥ USDT æ•°é‡">
            <span style="color:#00FFA3; font-weight:bold; cursor:pointer;" onclick="fillRec()">[å¡«å…¥å»ºè®®å€¼]</span>
        </div>

        <button class="btn btn-red" onclick="triggerBuyback()">ğŸ”¥ æ‹‰ç›˜å¹¶é”€æ¯ (BUY & BURN)</button>
    </div>
    
    <div style="text-align:center; font-size:12px; color:#333; margin-top:20px;">
        Authorized Personnel Only | GADKk Network
    </div>
</div>

<script>
    // --- 1. æ ¸å¿ƒé…ç½® ---
    const GADKK_ADDR    = "0xA1aEE242C69E1c0820d165ef12438e0A5eEd0BbA"; 
    const LP_FUND_ADDR  = "0xD7bB38219D069dfDD4F09Fdf568493A4B7d7E4fd"; 
    const BUYBACK_ADDR  = "0x3f22B4f6d76dD740AE3E22eb25bC22a884971ADB"; 
    const MARKETING_ADDR= "0x2DBE6300514C4D0Cd7456348512370D3A68d4c1E"; 
    const USDT_ADDR     = "0x55d398326f99059fF775485246999027B3197955"; 
    const MARKETING_TAX = 0.05; 

    // ABI å®šä¹‰
    const ABI_TOKEN = ["function balanceOf(address) view returns (uint256)", "function getPrice() view returns (uint256)"];
    const ABI_LP    = ["function process() external"]; 
    const ABI_BUY   = ["function buyUSDT(uint256) external", "function lastMarkBalance() view returns (uint256)"]; 

    let provider, signer, adminAddr;
    let recAmount = 0; 
    let maxUsdt = 0;   

    // --- 2. è¿æ¥ä¸ç­¾å ---
    async function connectWallet() {
        if (!window.ethereum) return alert("æœªæ£€æµ‹åˆ° MetaMask é’±åŒ…");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            adminAddr = await signer.getAddress();

            const msg = `GADKk Admin Login\nUser: ${adminAddr}\nTime: ${Date.now()}`;
            await signer.signMessage(msg);

            document.getElementById("connectBtn").innerText = "âœ… ç®¡ç†å‘˜å·²ç™»å½•";
            document.getElementById("connectBtn").style.background = "rgba(0, 255, 163, 0.1)";
            document.getElementById("connectBtn").style.borderColor = "#00FFA3";
            document.getElementById("connectBtn").style.color = "#00FFA3";

            refreshDashboard();
            setInterval(refreshDashboard, 15000); 

        } catch(e) {
            console.error(e);
            alert("ç™»å½•å¤±è´¥: " + (e.message || "ç”¨æˆ·å–æ¶ˆ"));
        }
    }

    // --- 3. æ•°æ®åˆ·æ–° ---
    async function refreshDashboard() {
        if(!provider) return;
        
        const tokenCt = new ethers.Contract(GADKK_ADDR, ABI_TOKEN, provider);
        const usdtCt = new ethers.Contract(USDT_ADDR, ABI_TOKEN, provider);
        const buybackCt = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, provider);

        try {
            const lpBal = await tokenCt.balanceOf(LP_FUND_ADDR);
            document.getElementById("lpFundBalance").innerText = parseFloat(ethers.utils.formatUnits(lpBal, 18)).toFixed(2);

            const usdtBal = await usdtCt.balanceOf(BUYBACK_ADDR);
            maxUsdt = parseFloat(ethers.utils.formatUnits(usdtBal, 18));
            document.getElementById("usdtBalance").innerText = maxUsdt.toFixed(2);

            const currentMarkRaw = await tokenCt.balanceOf(MARKETING_ADDR);
            const lastMarkRaw = await buybackCt.lastMarkBalance();
            
            const currentMark = parseFloat(ethers.utils.formatUnits(currentMarkRaw, 18));
            const lastMark = parseFloat(ethers.utils.formatUnits(lastMarkRaw, 18));
            
            let diff = currentMark - lastMark;
            if (diff < 0) diff = 0; 

            document.getElementById("pressureVal").innerText = diff.toFixed(2) + " ADKK";

            try {
                let estimatedPrice = 0.5; 
                recAmount = (diff * estimatedPrice).toFixed(2);
                document.getElementById("costTip").innerText = `å»ºè®®å›è´­: ${recAmount} USDT (ä¼°ç®—)`;
            } catch(err) {
                recAmount = 0;
            }

        } catch(e) {
            console.error("æ•°æ®åˆ·æ–°é”™è¯¯:", e);
        }
    }

    // --- 4. æ“ä½œåŠŸèƒ½ ---
    function fillRec() {
        if(recAmount > 0) document.getElementById("buyInput").value = recAmount;
        else alert("å½“å‰æ— æ˜æ˜¾æŠ›å‹æˆ–æ— æ³•è®¡ç®—");
    }

    function fillMax() {
        document.getElementById("buyInput").value = maxUsdt;
    }

    async function processLP() {
        if(!signer) return alert("è¯·å…ˆç™»å½•");
        const contract = new ethers.Contract(LP_FUND_ADDR, ABI_LP, signer);
        try {
            const tx = await contract.process({ gasLimit: 3000000 }); 
            alert("ğŸš€ åŠ æ± æŒ‡ä»¤å·²å‘é€ï¼\nHash: " + tx.hash);
            await tx.wait();
            alert("âœ… åŠ æ± æˆåŠŸï¼æµåŠ¨æ€§å·²å¢åŠ ã€‚");
            refreshDashboard();
        } catch(e) {
            alert("âŒ å¤±è´¥: " + (e.reason || e.message));
        }
    }

    async function triggerBuyback() {
        if(!signer) return alert("è¯·å…ˆç™»å½•");
        const inputVal = document.getElementById("buyInput").value;
        if(!inputVal || inputVal <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ USDT é‡‘é¢");

        const contract = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, signer);
        try {
            const weiAmt = ethers.utils.parseUnits(inputVal, 18);
            const tx = await contract.buyUSDT(weiAmt, { gasLimit: 1000000 });
            alert("ğŸ”¥ å›è´­æŒ‡ä»¤å·²å‘é€ï¼æ­£åœ¨æ‹‰ç›˜...\nHash: " + tx.hash);
            await tx.wait();
            alert("âœ… å›è´­æˆåŠŸï¼Kçº¿å·²æ‹‰å‡ã€‚");
            refreshDashboard();
        } catch(e) {
            alert("âŒ å¤±è´¥: " + (e.reason || e.message));
        }
    }
</script>
</body>
</html>
