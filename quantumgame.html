<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QUANTUM CASINO | GADKk</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon-green: #00FFA3; --neon-red: #FF2A6D; --neon-blue: #00C2FF; --neon-gold: #FFD700; --dark-bg: #050B14; --glass: rgba(12, 20, 30, 0.95); --border: rgba(255,255,255,0.15); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--dark-bg); color: #fff; font-family: 'Rajdhani', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100dvh; margin: 0; overflow-x: hidden; background-image: radial-gradient(circle at 50% 40%, #0d1a25 0%, #000 80%); padding-bottom: 20px; }
        .header { width: 100%; padding: 15px; display: flex; justify-content: space-between; align-items: center; max-width: 600px; height: 60px; z-index: 100; }
        .logo { font-family: 'Orbitron'; font-size: 16px; color: var(--neon-green); letter-spacing: 1px; display: flex; align-items: center; gap: 8px; text-shadow: 0 0 10px rgba(0,255,163,0.5); }
        .nav-right { display: flex; gap: 10px; align-items: center; }
        .icon-btn { width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 6px; display: flex; justify-content: center; align-items: center; cursor: pointer; background: rgba(255,255,255,0.05); font-family: 'Orbitron'; transition: 0.3s; }
        .lang-switch { display: flex; background: rgba(255,255,255,0.1); border-radius: 6px; padding: 2px; }
        .lang-btn { padding: 4px 8px; font-size: 10px; cursor: pointer; color: #888; font-weight: bold; border-radius: 4px; }
        .lang-btn.active { background: var(--neon-green); color: #000; }
        .wallet-btn { border: 1px solid var(--neon-green); color: var(--neon-green); background: rgba(0,255,163,0.1); padding: 5px 10px; border-radius: 4px; font-weight: bold; font-family: 'Orbitron'; font-size: 11px; cursor: pointer; }
        .global-stats { width: 100%; background: rgba(0,0,0,0.5); padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: center; gap: 20px; font-size: 11px; color: #888; z-index: 90; }
        .g-stat b { color: #fff; font-family: 'Orbitron'; margin-left: 4px; }
        .dashboard-container { width: 94%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; margin-top: 10px; z-index: 50; }
        .dashboard-row { display: flex; gap: 10px; }
        .dash-card { flex: 1; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; padding: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .dash-label { font-size: 10px; color: #888; display: block; margin-bottom: 4px; letter-spacing: 1px; }
        .dash-val { font-family: 'Orbitron'; font-size: 16px; font-weight: bold; color: #fff; }
        .val-gold { color: var(--neon-gold); text-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .val-red { color: var(--neon-red); text-shadow: 0 0 10px rgba(255,42,109,0.3); }
        .king-addr { font-size: 11px; color: var(--neon-green); font-family: 'Rajdhani'; font-weight: bold; margin-top: 2px; }
        .king-label { font-size: 9px; color: #666; display: block; margin-top: 4px; text-transform: uppercase; }
        .history-box { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; font-size: 11px; color: #aaa; display: flex; justify-content: space-around; align-items: center; margin-top: 5px; }
        .hist-item b { color: #fff; margin-left: 3px; font-family: 'Orbitron'; }
        .hist-item span { color: var(--neon-blue); font-weight: bold; margin-right: 3px; }
        .level-tabs { width: 94%; max-width: 500px; display: flex; background: rgba(0,0,0,0.3); border-radius: 10px; margin-top: 15px; padding: 4px; border: 1px solid rgba(255,255,255,0.1); z-index: 50; }
        .tab { flex: 1; text-align: center; padding: 10px 0; cursor: pointer; border-radius: 8px; font-family: 'Orbitron'; font-size: 12px; color: #666; transition: 0.3s; font-weight: bold; }
        .tab.active-0 { background: rgba(0, 255, 163, 0.2); color: var(--neon-green); border: 1px solid var(--neon-green); }
        .tab.active-1 { background: rgba(255, 215, 0, 0.2); color: var(--neon-gold); border: 1px solid var(--neon-gold); }
        .tab.active-2 { background: rgba(255, 42, 109, 0.2); color: var(--neon-red); border: 1px solid var(--neon-red); }
        .stage-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; overflow: hidden; margin: 10px 0; }
        .game-scale-box { transform-origin: center center; transition: transform 0.3s; }
        .game-container { position: relative; width: 340px; height: 340px; }
        .core { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 130px; height: 130px; border-radius: 50%; background: radial-gradient(circle, #fff 0%, var(--neon-green) 40%, transparent 80%); box-shadow: 0 0 50px var(--neon-green), inset 0 0 20px rgba(255,255,255,0.5); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; animation: breathe 2s ease-in-out infinite; border: 1px solid rgba(255,255,255,0.2); transition: 0.5s; }
        .core.critical { background: radial-gradient(circle, #fff 0%, var(--neon-red) 40%, transparent 80%); box-shadow: 0 0 80px var(--neon-red); animation: shake 0.5s infinite; }
        .core-text { color: #fff; font-weight: 900; font-size: 24px; font-family: 'Orbitron'; z-index: 11; text-shadow: 0 2px 5px rgba(0,0,0,0.8); letter-spacing: 1px; }
        .core-room { font-size: 10px; color: #aaa; margin-top: -2px; z-index: 11; font-family: 'Orbitron'; letter-spacing: 1px; }
        .core-count { font-size: 14px; color: #fff; font-weight: bold; margin-top: 4px; z-index: 11; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px; font-family: 'Orbitron'; }
        .slot { position: absolute; width: 60px; height: 60px; border: 1px solid rgba(255,255,255,0.2); border-radius: 14px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 20px; color: #fff; font-weight: 700; transition: 0.3s; background: rgba(20, 25, 30, 0.8); backdrop-filter: blur(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.6); font-family: 'Orbitron'; }
        .slot.active { border-color: var(--neon-green); background: rgba(0, 255, 163, 0.15); box-shadow: 0 0 20px rgba(0, 255, 163, 0.4); color: var(--neon-green); }
        .slot.is-me { border-color: var(--neon-gold); color: var(--neon-gold); background: rgba(255, 215, 0, 0.15); box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); transform: scale(1.1); z-index: 20; }
        .slot:nth-child(1) { top: 50%; left: 90%; transform: translate(-50%, -50%); } .slot:nth-child(2) { top: 85%; left: 70%; transform: translate(-50%, -50%); } .slot:nth-child(3) { top: 85%; left: 30%; transform: translate(-50%, -50%); } .slot:nth-child(4) { top: 50%; left: 10%; transform: translate(-50%, -50%); } .slot:nth-child(5) { top: 15%; left: 30%; transform: translate(-50%, -50%); } .slot:nth-child(6) { top: 15%; left: 70%; transform: translate(-50%, -50%); } 
        .panel-group { width: 94%; max-width: 500px; display: flex; flex-direction: column; gap: 10px; z-index: 20; padding-bottom: 20px; }
        .main-panel { background: var(--glass); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.8); }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #888; align-items: center; }
        .info-val { color: #fff; font-weight: bold; font-family: 'Orbitron'; letter-spacing: 1px; font-size: 15px; }
        .btn-inject { width: 100%; padding: 18px; border: none; border-radius: 10px; font-family: 'Orbitron'; font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; position: relative; overflow: hidden; transition: 0.3s; margin-top: 10px; }
        .btn-inject.join { background: var(--neon-green); color: #000; box-shadow: 0 0 30px rgba(0, 255, 163, 0.5); }
        .btn-inject.approve { background: #FFD700; color: #000; }
        /* ğŸ”¥ å…³é”®æ ·å¼ï¼šæ¥åŠ›è€…æŒ‰é’® */
        .btn-inject.breaker { 
            background: linear-gradient(135deg, #FF4500, #FFD700); 
            color: #fff; 
            box-shadow: 0 0 40px rgba(255, 69, 0, 0.6); 
            animation: pulseBtn 0.8s infinite;
        }
        .btn-inject:disabled { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
        .ref-panel { background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .ref-info div { font-size: 12px; color: #aaa; margin-bottom: 2px; }
        .ref-info b { color: var(--neon-green); }
        .btn-copy { background: rgba(255,255,255,0.1); border: 1px solid var(--border); padding: 8px 15px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 9990; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { width: 85%; max-width: 360px; background: #080c11; border: 1px solid var(--neon-green); border-radius: 20px; padding: 30px 20px; text-align: center; transform: scale(0.8); transition: 0.3s; box-shadow: 0 0 60px rgba(0,255,163,0.15); max-height: 85vh; overflow-y: auto; }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-icon { font-size: 48px; margin-bottom: 10px; display: block; }
        .modal-title { font-size: 24px; font-weight: 900; margin-bottom: 15px; color: var(--neon-green); font-family: 'Orbitron'; }
        .modal-content { text-align: left; color: #ccc; font-size: 13px; line-height: 1.6; }
        .modal-content h3 { color: var(--neon-green); font-size: 16px; margin: 15px 0 5px 0; border-bottom: 1px solid rgba(0,255,163,0.3); }
        .modal-btn { width: 100%; padding: 12px; background: transparent; color: var(--neon-green); border: 1px solid var(--neon-green); border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; font-family: 'Orbitron'; }
        .modal-box.win { border-color: var(--neon-gold); box-shadow: 0 0 60px rgba(255,215,0,0.2); } .modal-box.win .modal-title, .modal-box.win .modal-btn { color: var(--neon-gold); border-color: var(--neon-gold); }
        .modal-box.lose { border-color: var(--neon-red); box-shadow: 0 0 60px rgba(255,42,109,0.2); } .modal-box.lose .modal-title, .modal-box.lose .modal-btn { color: var(--neon-red); border-color: var(--neon-red); }
        .toast-container { position: fixed; top: 80px; right: 20px; z-index: 10000; }
        .toast { background: rgba(10, 15, 20, 0.95); border-left: 4px solid #fff; padding: 12px 16px; margin-bottom: 10px; border-radius: 6px; color: #fff; min-width: 240px; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); transform: translateX(120%); transition: 0.3s; display: flex; align-items: center; gap: 12px; }
        .toast.show { transform: translateX(0); } .toast.success { border-left-color: var(--neon-green); } .toast.error { border-left-color: var(--neon-red); }

        @keyframes breathe { 0%, 100% { transform: translate(-50%, -50%) scale(1); filter: brightness(1); } 50% { transform: translate(-50%, -50%) scale(1.15); filter: brightness(1.3); } }
        @keyframes shake { 0% { transform: translate(-51%, -51%) } 25% { transform: translate(-49%, -50%) } 50% { transform: translate(-50%, -49%) } 75% { transform: translate(-51%, -50%) } 100% { transform: translate(-50%, -50%) } }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        @media (max-height: 800px) { .game-scale-box { transform: scale(0.85); } }
    </style>
</head>
<body>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-box" id="modalBox">
        <span class="modal-icon" id="mIcon"></span>
        <div class="modal-title" id="mTitle">TITLE</div>
        <div class="modal-content" id="mContent"></div>
        <button class="modal-btn" onclick="closeModal()" id="mBtn">CLOSE</button>
    </div>
</div>
<div class="toast-container" id="toastContainer"></div>

<div class="header">
    <div class="logo">QUANTUM CASINO</div>
    <div class="nav-right">
        <div class="icon-btn" onclick="showRules()">?</div>
        <div class="lang-switch">
            <div class="lang-btn active" id="lang-en" onclick="setLang('en')">EN</div>
            <div class="lang-btn" id="lang-cn" onclick="setLang('cn')">CN</div>
        </div>
        <div class="wallet-btn" id="connectBtn" onclick="connectWallet()" data-i18n="btn_connect">CONNECT</div>
    </div>
</div>

<div class="global-stats">
    <div class="g-stat g-live"><span data-i18n="lbl_online">ONLINE:</span> <b id="gOnline">--</b></div>
    <div class="g-stat"><span data-i18n="lbl_rounds">ROUNDS:</span> <b id="gRounds">--</b></div>
</div>

<div class="dashboard-container">
    <div class="dashboard-row">
        <div class="dash-card">
            <span class="dash-label" data-i18n="lbl_pool">HOPE POOL</span>
            <div class="dash-val val-gold" id="poolVal">--</div>
        </div>
        <div class="dash-card">
            <span class="dash-label" data-i18n="lbl_time">FOMO TIMER</span>
            <div class="dash-val val-red" id="timeVal">--:--:--</div>
            <span class="king-label" data-i18n="lbl_king">CURRENT KING</span>
            <div class="king-addr" id="kingAddr">--</div>
        </div>
    </div>
    <div class="history-box">
        <div class="hist-item"><span>â˜ ï¸ LUCKY:</span><b id="lastLucky">--</b></div>
        <div class="hist-item"><span>ğŸ‘‘ FOMO:</span><b id="lastFomo">--</b></div>
    </div>
</div>

<div class="level-tabs">
    <div class="tab active-0" onclick="setLevel(0)" id="tab-0">NOVICE<br>100</div>
    <div class="tab" onclick="setLevel(1)" id="tab-1">ELITE<br>1K</div>
    <div class="tab" onclick="setLevel(2)" id="tab-2">WHALE<br>10K</div>
</div>

<div class="stage-wrapper">
    <div class="game-scale-box">
        <div class="game-container">
            <div class="slot" id="slot-0">1</div><div class="slot" id="slot-1">2</div><div class="slot" id="slot-2">3</div>
            <div class="slot" id="slot-3">4</div><div class="slot" id="slot-4">5</div><div class="slot" id="slot-5">6</div>
            <div class="core" id="core">
                <div class="core-text" id="statusText">WAIT</div>
                <div class="core-room" id="roomDisplay">ROOM #--</div>
                <div class="core-count" id="playerCount">0/6</div>
            </div>
        </div>
    </div>
</div>

<div class="panel-group">
    <div class="main-panel">
        <div class="info-row"><span data-i18n="entry_fee">ENTRY FEE</span><span class="info-val" id="entryFeeDisplay">--</span></div>
        <div class="info-row"><span data-i18n="balance">MY BALANCE</span><span class="info-val" id="myBalance">--</span></div>
        <div class="info-row"><span data-i18n="status">STATUS</span><span class="info-val" id="gameState" style="color:var(--neon-green)">STABLE</span></div>
        <button class="btn-inject join" id="actionBtn" onclick="handleAction()">
            <span data-i18n="btn_connect_first">CONNECT FIRST</span>
        </button>
    </div>
    
    <div class="ref-panel">
        <div class="ref-info">
            <div id="refUpline"><span data-i18n="lbl_upline">Upline:</span> --</div>
            <div id="refCount"><span data-i18n="lbl_invites">Invites:</span> 0</div>
        </div>
        <div class="btn-copy" onclick="copyRef()" data-i18n="btn_copy">COPY INVITE</div>
    </div>
</div>

<script>
    // âš ï¸ CONTRACT CONFIG V7.5
    const TOKEN_ADDR = "0xA1aEE242C69E1c0820d165ef12438e0A5eEd0BbA"; 
    const GAME_ADDR  = "0xf58ECA0e4611162FA103169430156A579e47b60d"; 
    
    let currentLevel = 0;
    let provider, signer, userAddr, gameContract, tokenContract;
    let entryFeeVal = ethers.BigNumber.from(0);
    let fomoDeadline = 0;
    let timerInterval;
    let currentLang = localStorage.getItem('gadkk_lang') || 'cn';

    const i18n = {
        en: {
            btn_connect: "CONNECT", entry_fee: "TICKET", balance: "BALANCE", status: "STATUS", status_stable: "STABLE", status_critical: "PENDING BREAK", status_wait: "WAIT",
            btn_connect_first: "CONNECT WALLET", btn_approve: "APPROVE", btn_join: "INJECT ENERGY", btn_joined: "JOINED (WAITING)", btn_breaker: "SETTLE & START", btn_processing: "PROCESSING...",
            lbl_pool: "HOPE POOL", lbl_time: "FOMO TIMER", btn_copy: "COPY LINK", lbl_online: "ONLINE:", lbl_rounds: "ROUNDS:", lbl_upline: "Upline:", lbl_invites: "Invites:", lbl_king: "CURRENT KING",
            toast_connect: "Connected", toast_tx_sent: "Tx Sent...", toast_success: "Success!", toast_error: "Error: ", toast_copied: "Link Copied!", toast_wrong_net: "Switch to BNB Chain",
            rules_title: "GAME RULES", rules_btn: "CLOSE",
            rules_html: `<h3>ğŸ›¡ï¸ Secure Relay</h3><p>6th player locks the room. 7th player (Breaker) settles previous room & joins new one.</p><h3>ğŸ’ Referral</h3><p>Earn 5% (L1) + 2% (L2).</p><h3>â³ FOMO</h3><p>Last player wins 50% pool.</p><h3>ğŸ’° Split</h3><p>85% Winners | 2% Burn | 12% Pool</p>`,
            win_title: "VICTORY!", win_msg: "You survived! Rewards sent to wallet.",
            lose_title: "ELIMINATED", lose_msg: "Energy consumed. Better luck next time."
        },
        cn: {
            btn_connect: "è¿æ¥é’±åŒ…", entry_fee: "é—¨ç¥¨ä»·æ ¼", balance: "è´¦æˆ·ä½™é¢", status: "ç³»ç»ŸçŠ¶æ€", status_stable: "ç³»ç»Ÿç¨³å®š", status_critical: "ç­‰å¾…ç ´å±€", status_wait: "ç­‰å¾…ä¸­",
            btn_connect_first: "è¿æ¥é’±åŒ…", btn_approve: "æˆæƒä»£å¸", btn_join: "æ³¨å…¥èƒ½é‡", btn_joined: "å·²å…¥åº§ (ç­‰å¾…ç»“ç®—)", btn_breaker: "ğŸš€ ç»“ç®— & å¼€å¯æ–°å±€", btn_processing: "å¤„ç†ä¸­...",
            lbl_pool: "å¸Œæœ›å¥–æ± ", lbl_time: "æœ«æ—¥å€’è®¡æ—¶", btn_copy: "å¤åˆ¶é‚€è¯·é“¾æ¥", lbl_online: "åœ¨çº¿äººæ•°:", lbl_rounds: "æ€»å±€æ•°:", lbl_upline: "æˆ‘çš„ä¸Šçº§:", lbl_invites: "å·²é‚€è¯·:", lbl_king: "å½“å‰éœ¸ä¸»",
            toast_connect: "é’±åŒ…å·²è¿æ¥", toast_tx_sent: "äº¤æ˜“å·²å‘é€...", toast_success: "æ“ä½œæˆåŠŸ", toast_error: "é”™è¯¯: ", toast_copied: "é“¾æ¥å·²å¤åˆ¶", toast_wrong_net: "è¯·åˆ‡æ¢åˆ° BSC é“¾",
            rules_title: "æ¸¸æˆè§„åˆ™", rules_btn: "å…³é—­",
            rules_html: `<h3>ğŸ›¡ï¸ é‡å­æ¥åŠ›</h3><p>ç¬¬6äººå°ç›˜ï¼Œç¬¬7äººï¼ˆç ´å±€è€…ï¼‰è´Ÿè´£ç»“ç®—ä¸Šä¸€å±€å¹¶å¼€å¯æ–°å±€ï¼Œæœç»ä½œå¼Šã€‚</p><h3>ğŸ’ åŒå±‚è£‚å˜</h3><p>ä¸€çº§ 5% | äºŒçº§ 2%</p><h3>â³ FOMO å¤§å¥–</h3><p>å€’è®¡æ—¶å½’é›¶ï¼Œæœ€åä¸€äººç‹¬å50%å¥–æ± ã€‚</p><h3>ğŸ’° èµ„é‡‘åˆ†é…</h3><p>85% å¹¸å­˜è€… | 2% é”€æ¯ | 12% å¥–æ± </p>`,
            win_title: "å¤§å‰å¤§åˆ©", win_msg: "æ­å–œï¼æ‚¨å¹¸å­˜å¹¶è·å¾—äº†å¥–åŠ±ã€‚",
            lose_title: "é—æ†¾æ·˜æ±°", lose_msg: "èƒ½é‡è¢«åå™¬ã€‚è¯·æœŸå¾…å¹¸è¿æŠ¤ç›¾è¡¥å¿ã€‚"
        }
    };

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        if (type === 'click') {
            osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now+0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if (type === 'coin') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(1500 + Math.random()*500, now);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if (type === 'win') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.6);
            osc.start(now); osc.stop(now+0.6);
            for(let i=0; i<10; i++) setTimeout(() => playSound('coin'), i*100);
        } else if (type === 'lose') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.linearRampToValueAtTime(0, now+0.4);
            osc.start(now); osc.stop(now+0.4);
        }
    }

    function fireConfetti() {
        var end = Date.now() + 3000;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, zIndex: 99999, colors: ['#FFD700', '#F0E68C'] });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, zIndex: 99999, colors: ['#FFD700', '#F0E68C'] });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        const ref = params.get('ref');
        if(ref && ethers.utils.isAddress(ref)) localStorage.setItem('gadkk_ref', ref);
        setLang(currentLang);
    };

    function setLang(lang) {
        currentLang = lang; localStorage.setItem('gadkk_lang', lang);
        document.getElementById('lang-cn').classList.toggle('active', lang==='cn');
        document.getElementById('lang-en').classList.toggle('active', lang==='en');
        updateTexts(); playSound('click');
    }

    function updateTexts() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
        });
        document.getElementById('mBtn').innerText = i18n[currentLang].rules_btn;
    }

    function setLevel(lvl) {
        currentLevel = lvl;
        document.querySelectorAll('.tab').forEach((el, i) => { el.className = `tab ${i === lvl ? 'active-'+i : ''}`; });
        playSound('click'); refreshData();
    }

    function showModal(type, title, content) {
        const box = document.getElementById('modalBox'); const icon = document.getElementById('mIcon');
        box.className = 'modal-box ' + type;
        if (type === 'win') { icon.innerText = 'ğŸ†'; playSound('win'); fireConfetti(); }
        else if (type === 'lose') { icon.innerText = 'ğŸ’€'; playSound('lose'); }
        else { icon.innerText = 'ğŸ“œ'; playSound('click'); }
        document.getElementById('mTitle').innerText = title; document.getElementById('mContent').innerHTML = content;
        document.getElementById('modalOverlay').classList.add('show');
    }
    function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); playSound('click'); }
    function showRules() { showModal('normal', i18n[currentLang].rules_title, i18n[currentLang].rules_html); }
    function showToast(msg, type='info') {
        const div = document.createElement('div'); div.className = `toast ${type}`;
        div.innerHTML = `<span>${type==='success'?'âœ…':(type==='error'?'âŒ':'â„¹ï¸')}</span><span>${msg}</span>`;
        document.getElementById('toastContainer').appendChild(div);
        setTimeout(()=>div.classList.add('show'),10); setTimeout(()=>div.remove(),3000);
    }

    async function connectWallet() {
        if (!window.ethereum) return alert("Install MetaMask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const network = await provider.getNetwork();
            if (network.chainId !== 56) {
                showToast(i18n[currentLang].toast_wrong_net, "error");
                try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] }); } catch (e) {}
            }
            signer = provider.getSigner(); userAddr = await signer.getAddress();
            document.getElementById("connectBtn").innerText = userAddr.substring(0, 6) + "...";
            
            const ABI_TOKEN = ["function approve(address,uint) external", "function allowance(address,address) view returns (uint)", "function balanceOf(address) view returns (uint)"];
            const ABI_GAME = [
                "function injectEnergy(uint256, address) external",
                "function getGlobalState() view returns (uint256, uint256, uint256, uint256, address, tuple(address,uint,uint), tuple(address,uint,uint))",
                "function getLevelState(uint256) view returns (address[], uint256, uint256, uint256, bool)",
                "function referrers(address) view returns (address)",
                "function referralCount(address) view returns (uint256)",
                "event RoundSettled(uint256, uint256, address, uint256)"
            ];
            
            tokenContract = new ethers.Contract(TOKEN_ADDR, ABI_TOKEN, signer);
            gameContract = new ethers.Contract(GAME_ADDR, ABI_GAME, signer);
            
            showToast(i18n[currentLang].toast_connect, "success");
            playSound('click'); startTimer(); setInterval(refreshData, 3000); refreshData(); listenEvents();
        } catch(e) { console.error(e); }
    }

    async function refreshData() {
        if(!userAddr || !gameContract) return;
        try {
            // 1. Get Global Data
            const gData = await gameContract.getGlobalState();
            const lData = await gameContract.getLevelState(currentLevel);
            
            document.getElementById("gOnline").innerText = gData[0].toString();
            document.getElementById("gRounds").innerText = gData[1].toString();
            document.getElementById("poolVal").innerText = parseFloat(ethers.utils.formatUnits(gData[2], 18)).toLocaleString();
            fomoDeadline = gData[3].toNumber();
            const lastPlayer = gData[4];
            const lastLucky = gData[5];
            const lastFomo = gData[6];

            document.getElementById("kingAddr").innerText = (lastPlayer === ethers.constants.AddressZero) ? "--" : lastPlayer.substring(0,8)+"...";
            if(lastLucky[1] > 0) document.getElementById("lastLucky").innerText = `${lastLucky[0].substring(0,6)}... (${parseFloat(ethers.utils.formatUnits(lastLucky[1],18)).toFixed(0)})`;
            else document.getElementById("lastLucky").innerText = "--";
            if(lastFomo[1] > 0) document.getElementById("lastFomo").innerText = `${lastFomo[0].substring(0,6)}... (${parseFloat(ethers.utils.formatUnits(lastFomo[1],18)).toFixed(0)})`;
            else document.getElementById("lastFomo").innerText = "--";

            // 2. Get Level Data
            const roomPlayers = lData[0];
            document.getElementById("roomDisplay").innerText = `ROOM #${lData[1].toString()}`;
            entryFeeVal = lData[2];
            document.getElementById("entryFeeDisplay").innerText = parseFloat(ethers.utils.formatUnits(entryFeeVal, 18)).toLocaleString() + " GADKk";
            const isPending = lData[4]; // Check if pending state

            const bal = await tokenContract.balanceOf(userAddr);
            document.getElementById("myBalance").innerText = parseFloat(ethers.utils.formatUnits(bal, 18)).toFixed(2);
            
            const myUpline = await gameContract.referrers(userAddr);
            const myCount = await gameContract.referralCount(userAddr);
            document.getElementById("refUpline").innerHTML = `<span data-i18n="lbl_upline">${i18n[currentLang].lbl_upline}</span> ${myUpline === ethers.constants.AddressZero ? 'None' : myUpline.substring(0,6)+'...'}`;
            document.getElementById("refCount").innerHTML = `<span data-i18n="lbl_invites">${i18n[currentLang].lbl_invites}</span> ${myCount}`;

            updateSlots(roomPlayers, isPending); 
            checkButtonState(roomPlayers, isPending);
        } catch(e) { console.log(e); }
    }

    function updateSlots(players, isPending) {
        const count = players.length;
        document.getElementById("playerCount").innerText = `${count}/6`;
        const core = document.getElementById("core");
        let colorVar = currentLevel === 0 ? '--neon-green' : (currentLevel === 1 ? '--neon-gold' : '--neon-red');
        core.style.background = `radial-gradient(circle, #fff 0%, var(${colorVar}) 40%, transparent 80%)`;
        
        // å¦‚æœæ˜¯ Pending çŠ¶æ€ï¼Œå¼ºåˆ¶æ˜¾ç¤ºçº¢è‰²è­¦æŠ¥
        if(isPending || count >= 6) { 
            document.getElementById("statusText").innerText = "FULL"; 
            core.classList.add('critical'); 
        } else { 
            document.getElementById("statusText").innerText = "WAIT"; 
            core.classList.remove('critical'); 
        }

        for(let i=0; i<6; i++) {
            const el = document.getElementById(`slot-${i}`);
            el.className = 'slot'; el.innerText = i+1; el.innerHTML = `<span>${i+1}</span>`;
            if(i < count) {
                el.classList.add('active'); el.innerHTML = 'âš¡';
                if(players[i].toLowerCase() === userAddr.toLowerCase()) el.classList.add('is-me');
            }
        }
    }

    async function checkButtonState(players, isPending) {
        const btn = document.getElementById("actionBtn"); if(btn.disabled) return;
        const isJoined = players.some(p => p.toLowerCase() === userAddr.toLowerCase());
        
        // 1. å·²åŠ å…¥ï¼Œç­‰å¾…ç»“ç®—
        if (isJoined) {
            btn.className = "btn-inject"; btn.style.background = "#333"; 
            btn.innerText = i18n[currentLang].btn_joined; btn.onclick = null;
            return;
        }
        
        // 2. æ»¡å‘˜å¾…ç ´å±€ (ç¬¬7äºº)
        if (isPending) {
            btn.className = "btn-inject breaker"; 
            btn.innerText = i18n[currentLang].btn_breaker;
            checkAllowanceInternal(btn);
            return;
        }
        
        // 3. æ­£å¸¸åŠ å…¥
        btn.className = "btn-inject join"; 
        btn.innerText = i18n[currentLang].btn_join;
        checkAllowanceInternal(btn);
    }

    async function checkAllowanceInternal(btn) {
        try {
            const allowed = await tokenContract.allowance(userAddr, GAME_ADDR);
            if(allowed.lt(entryFeeVal)) { 
                btn.className = "btn-inject approve"; btn.innerText = i18n[currentLang].btn_approve; btn.onclick = approveToken; 
            } else { 
                // Keep the class set by checkButtonState (either breaker or join)
                btn.onclick = inject; 
            }
        } catch(e){}
    }

    async function approveToken() {
        setLoading(true);
        try {
            const tx = await tokenContract.approve(GAME_ADDR, ethers.constants.MaxUint256);
            showToast(i18n[currentLang].toast_tx_sent); await tx.wait();
            showToast(i18n[currentLang].toast_success, "success"); playSound('click');
        } catch(e) { showToast(i18n[currentLang].toast_error, "error"); }
        setLoading(false);
    }

    async function inject() {
        setLoading(true);
        try {
            const ref = localStorage.getItem('gadkk_ref') || "0x0000000000000000000000000000000000000000";
            const tx = await gameContract.injectEnergy(currentLevel, ref, {gasLimit: 600000});
            showToast(i18n[currentLang].toast_tx_sent); await tx.wait(); playSound('coin');
        } catch(e) { showToast(i18n[currentLang].toast_error + (e.reason || "Reverted"), "error"); }
        setLoading(false);
    }

    function setLoading(b) {
        const btn = document.getElementById("actionBtn");
        if(b) { btn.disabled=true; btn.innerHTML = `<span class="loader">...</span>`; } else { btn.disabled=false; refreshData(); }
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const now = Math.floor(Date.now()/1000);
            const diff = fomoDeadline - now;
            const el = document.getElementById("timeVal");
            if(diff <= 0) el.innerText = "00:00:00";
            else {
                const h = Math.floor(diff/3600).toString().padStart(2,'0');
                const m = Math.floor((diff%3600)/60).toString().padStart(2,'0');
                const s = (diff%60).toString().padStart(2,'0');
                el.innerText = `${h}:${m}:${s}`;
            }
        }, 1000);
    }

    function copyRef() {
        if(!userAddr) return showToast("Connect Wallet First", "error");
        const url = `${window.location.origin}${window.location.pathname}?ref=${userAddr}`;
        navigator.clipboard.writeText(url); showToast(i18n[currentLang].toast_copied, "success");
    }
    
    function listenEvents() {
        gameContract.on("RoundSettled", (lvl, rid, loser, reward) => {
            if(lvl.toNumber() === currentLevel) {
                setTimeout(() => {
                    const isLoser = (loser.toLowerCase() === userAddr.toLowerCase());
                    const r = i18n[currentLang];
                    if (isLoser) showModal('lose', r.lose_title, r.lose_msg);
                    else showModal('win', r.win_title, r.win_msg);
                    refreshData();
                }, 2000);
            }
        });
    }
    function handleAction() { if(!userAddr) connectWallet(); }
</script>
</body>
</html>
