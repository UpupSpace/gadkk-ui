<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GADKk ADMIN v5.0 (Ledger)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¡€ UI --- */
        * { box-sizing: border-box; }
        body { background-color: #050505; background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 70%); color: #fff; font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; }
        .container { width: 100%; max-width: 500px; position: relative; z-index: 10; }
        
        .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #222; padding-bottom: 20px; }
        h1 { margin: 0; font-family: 'Rajdhani', sans-serif; letter-spacing: 4px; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .version-tag { background: linear-gradient(90deg, #FFD700, #FFA500); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 12px; vertical-align: middle; margin-left: 10px; font-weight: bold; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: rgba(20, 20, 20, 0.6); border: 1px solid #333; backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .card-header { display: flex; justify-content: space-between; align-items: center; color: #888; font-size: 13px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        
        /* æ ¸å¿ƒæ•°æ®å±•ç¤º */
        .big-num { font-size: 32px; font-weight: bold; font-family: 'Rajdhani', sans-serif; color: #00FFA3; text-shadow: 0 0 10px rgba(0, 255, 163, 0.3); }
        .unit { font-size: 14px; color: #666; margin-left: 4px; }

        /* é—´è°ç›‘æ§åŒº (ä¸‰å±‚æ•°æ®) */
        .spy-dashboard { background: #0f0f0f; border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #222; }
        .data-row:last-child { border: none; margin: 0; padding: 0; }
        .data-label { color: #888; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .data-val { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 18px; color: #eee; }
        .highlight-val { color: #FF4500; font-size: 22px; text-shadow: 0 0 10px rgba(255, 69, 0, 0.3); }

        /* è¾“å…¥ä¸æŒ‰é’® */
        .input-wrapper { position: relative; background: #111; border: 1px solid #444; border-radius: 8px; display: flex; align-items: center; padding: 0 15px; transition: 0.3s; margin-bottom: 15px; }
        .input-wrapper:focus-within { border-color: #FF4500; box-shadow: 0 0 10px rgba(255, 69, 0, 0.2); }
        .input-wrapper input { width: 100%; background: none; border: none; color: #fff; font-size: 18px; padding: 16px 0; font-family: 'Rajdhani', sans-serif; outline: none; }
        .input-suffix { color: #666; font-size: 12px; white-space: nowrap; }
        
        .auto-fill-btn { color: #00FFA3; font-size: 12px; cursor: pointer; text-decoration: underline; margin-left: 10px; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; font-family: 'Rajdhani', sans-serif; letter-spacing: 1px; transition: all 0.2s; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.98); }
        .btn-connect { background: #222; color: #ccc; border: 1px solid #444; margin-bottom: 20px; }
        .btn-green { background: linear-gradient(135deg, #00FFA3, #008cff); color: #000; box-shadow: 0 4px 15px rgba(0, 255, 163, 0.3); }
        .btn-red { background: linear-gradient(135deg, #FF4500, #ff0055); color: #fff; box-shadow: 0 4px 15px rgba(255, 69, 0, 0.3); }

        /* é«˜çº§ Toast å¼¹çª—æ ·å¼ */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(20, 20, 20, 0.95); border-left: 4px solid; padding: 15px 20px; border-radius: 4px; color: #fff; min-width: 300px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); font-size: 14px; }
        .toast.show { transform: translateX(0); }
        .toast-success { border-color: #00FFA3; }
        .toast-error { border-color: #FF4500; }
        .toast-info { border-color: #00C2FF; }
        .toast-icon { margin-right: 10px; font-size: 18px; }
    </style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div class="container">
    <div class="header">
        <h1>GADKk ADMIN <span class="version-tag">v5.0</span></h1>
        <div style="font-size:12px; color:#555; margin-top:5px;">FINANCE LEDGER SYSTEM</div>
    </div>

    <button id="connectBtn" class="btn btn-connect" onclick="connectWallet()">ğŸ”‘ éªŒè¯ç®¡ç†å‘˜èº«ä»½ (Verify Identity)</button>

    <div class="card">
        <div class="card-header">
            <span>ğŸ›¡ï¸ LP FUND (è‡ªåŠ¨å›æµ)</span>
            <span style="color:#00FFA3"><span class="dot" style="background:#00FFA3"></span>Running</span>
        </div>
        <div class="big-num">
            <span id="lpFundBalance">--</span><span class="unit">ADKK</span>
        </div>
        <div style="margin: 10px 0; font-size: 12px; color: #666;">å¾…æ³¨å…¥èµ„é‡‘æ± çš„ä»£å¸ä½™é¢</div>
        <button class="btn btn-green" onclick="processLP()">âš¡ æ‰§è¡ŒåŠ æ±  (PROCESS)</button>
    </div>

    <div class="card" style="border-color: rgba(255, 69, 0, 0.3);">
        <div class="card-header">
            <span>ğŸš€ BUYBACK (æ™ºèƒ½å›è´­)</span>
            <span style="color:#FF4500"><span class="dot" style="background:#FF4500"></span>Ready</span>
        </div>

        <div class="spy-dashboard">
            <div class="data-row">
                <div class="data-label">ğŸ¦ è¥é”€é’±åŒ…ä½™é¢ (Real Balance)</div>
                <div class="data-val" id="marketingBal">0.00</div>
            </div>
            <div class="data-row">
                <div class="data-label">ğŸ“‰ å¾…å¤„ç†ç§¯å‹ (Unsold Backlog)</div>
                <div class="data-val" style="color: #FFD700" id="backlogBal">0.00</div>
            </div>
            <div class="data-row">
                <div class="data-label">âš ï¸ å‰©ä½™å¸‚åœºæŠ›å‹ (Remaining Vol)</div>
                <div class="data-val highlight-val" id="marketVolume">0.00</div>
            </div>
            
            <div style="text-align: right; font-size: 12px; margin-top: 5px;">
                <span class="auto-fill-btn" onclick="fillBacklog()">[å¡«å…¥å…¨éƒ¨ç§¯å‹]</span>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; font-size:12px; color:#888; margin-bottom:5px;">
            <span>USDT é‡‘åº“: <span id="usdtBalance" style="color:#fff">--</span></span>
            <span>å½“å‰å¸ä»·: <span id="tokenPrice" style="color:#00C2FF">Calculating...</span></span>
        </div>

        <div class="input-wrapper">
            <input type="number" id="targetAdkk" placeholder="è¾“å…¥è¦ä¹°å…¥çš„ ADKK æ•°é‡" oninput="calculateCost()">
            <span class="input-suffix">ADKK</span>
        </div>
        
        <div style="text-align:right; font-size:12px; color:#FF4500; margin-bottom:15px; height: 16px;">
            <span id="costPreview"></span>
        </div>

        <button class="btn btn-red" onclick="triggerBuyback()">ğŸ”¥ å¼ºåŠ›æ‹‰ç›˜ (BUY)</button>
    </div>
</div>

<script>
    // --- é…ç½®åŒº ---
    const GADKK_ADDR    = "0xA1aEE242C69E1c0820d165ef12438e0A5eEd0BbA"; 
    const LP_FUND_ADDR  = "0xD7bB38219D069dfDD4F09Fdf568493A4B7d7E4fd"; 
    const BUYBACK_ADDR  = "0x3f22B4f6d76dD740AE3E22eb25bC22a884971ADB"; 
    const MARKETING_ADDR= "0x2DBE6300514C4D0Cd7456348512370D3A68d4c1E"; 
    const USDT_ADDR     = "0x55d398326f99059fF775485246999027B3197955"; 
    const PAIR_ADDR     = "0x5B06dc147F363aa0111549fb5EA992A40feda6fC"; 
    
    const MARKETING_TAX_RATE = 0.05; 

    // ABI
    const ABI_COMMON = ["function balanceOf(address) view returns (uint256)"];
    const ABI_LP     = ["function process() external"]; 
    const ABI_BUY    = ["function buyUSDT(uint256) external", "function lastMarkBalance() view returns (uint256)"]; 

    let provider, signer;
    let currentPrice = 0;
    let backlog = 0;  // ç§¯å‹é‡
    let usdtCost = 0; // è®¡ç®—å‡ºçš„æˆæœ¬

    // --- Toast å¼¹çª—ç³»ç»Ÿ ---
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        let icon = 'â„¹ï¸';
        if(type === 'success') icon = 'âœ…';
        if(type === 'error') icon = 'âŒ';

        toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
        container.appendChild(toast);

        // åŠ¨ç”»
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // --- è¿æ¥ ---
    async function connectWallet() {
        if (!window.ethereum) return showToast("è¯·å®‰è£… MetaMask é’±åŒ…", 'error');
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const adminAddr = await signer.getAddress();

            // ç­¾åç™»å½•
            const msg = `Admin Access Verification\nUser: ${adminAddr}\nTimestamp: ${Date.now()}`;
            await signer.signMessage(msg);

            document.getElementById("connectBtn").innerText = "âœ… ç®¡ç†å‘˜å·²ç™»å½•";
            document.getElementById("connectBtn").style.background = "rgba(0, 255, 163, 0.1)";
            document.getElementById("connectBtn").style.color = "#00FFA3";
            document.getElementById("connectBtn").style.border = "1px solid #00FFA3";

            showToast("ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼æ­£åœ¨åŠ è½½æ•°æ®...", "success");
            refreshDashboard();
            setInterval(refreshDashboard, 10000); 

        } catch(e) {
            showToast("ç™»å½•å·²å–æ¶ˆ", "error");
        }
    }

    // --- æ ¸å¿ƒæ•°æ®é€»è¾‘ ---
    async function refreshDashboard() {
        if(!provider) return;
        
        const tokenCt = new ethers.Contract(GADKK_ADDR, ABI_COMMON, provider);
        const usdtCt = new ethers.Contract(USDT_ADDR, ABI_COMMON, provider);
        const buybackCt = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, provider);

        try {
            // 1. LP Fund ä½™é¢
            const lpBal = await tokenCt.balanceOf(LP_FUND_ADDR);
            document.getElementById("lpFundBalance").innerText = parseFloat(ethers.utils.formatUnits(lpBal, 18)).toFixed(2);

            // 2. USDT é‡‘åº“ä½™é¢
            const usdtBal = await usdtCt.balanceOf(BUYBACK_ADDR);
            document.getElementById("usdtBalance").innerText = parseFloat(ethers.utils.formatUnits(usdtBal, 18)).toFixed(2);

            // 3. ä»·æ ¼è®¡ç®—
            const poolAdkkRaw = await tokenCt.balanceOf(PAIR_ADDR);
            const poolUsdtRaw = await usdtCt.balanceOf(PAIR_ADDR);
            const poolAdkk = parseFloat(ethers.utils.formatUnits(poolAdkkRaw, 18));
            const poolUsdt = parseFloat(ethers.utils.formatUnits(poolUsdtRaw, 18));
            if(poolAdkk > 0) {
                currentPrice = poolUsdt / poolAdkk;
                document.getElementById("tokenPrice").innerText = currentPrice.toFixed(6) + " U";
            }

            // 4. ä¸‰å±‚ç›‘æ§é€»è¾‘ (æ ¸å¿ƒ)
            // A. çœŸå®ä½™é¢
            const realMarkRaw = await tokenCt.balanceOf(MARKETING_ADDR);
            const realMark = parseFloat(ethers.utils.formatUnits(realMarkRaw, 18));
            document.getElementById("marketingBal").innerText = realMark.toFixed(2);

            // B. è®¡ç®—ç§¯å‹ (Backlog)
            // é€»è¾‘ï¼šå½“å‰çœŸå®ä½™é¢ - ä¸Šæ¬¡è®°å½•ç‚¹ = æ–°å¢çš„ç¨
            // æ³¨æ„ï¼šå¦‚æœåˆçº¦å·²ç»æŠŠå¸å–äº†ï¼Œè¿™ä¸ªå€¼ä¼šè‡ªåŠ¨å˜å°ï¼Œå®ç°â€œåŠ¨æ€æ‰£å‡â€
            const lastMarkRaw = await buybackCt.lastMarkBalance();
            const lastMark = parseFloat(ethers.utils.formatUnits(lastMarkRaw, 18));
            
            backlog = realMark - lastMark; 
            if(backlog < 0) backlog = 0; // å½’é›¶ä¿æŠ¤
            
            document.getElementById("backlogBal").innerText = backlog.toFixed(2);

            // C. åæ¨å¸‚åœºæŠ›å‹ (Volume)
            // é€»è¾‘ï¼šç§¯å‹çš„ç¨ / ç¨ç‡ = è¿˜æ²¡è¢«å¤„ç†çš„å¸‚åœºæŠ›å‹
            const impliedVolume = backlog / MARKETING_TAX_RATE;
            document.getElementById("marketVolume").innerText = impliedVolume.toFixed(2);

        } catch(e) { console.error(e); }
    }

    // --- äº¤äº’è®¡ç®— ---
    function fillBacklog() {
        if(backlog > 0) {
            document.getElementById("targetAdkk").value = backlog.toFixed(2);
            calculateCost();
            showToast("å·²å¡«å…¥å…¨éƒ¨ç§¯å‹æ•°é‡", "info");
        } else {
            showToast("å½“å‰æ²¡æœ‰ç§¯å‹ï¼Œæ— éœ€å›è´­", "info");
        }
    }

    function calculateCost() {
        const inputAdkk = parseFloat(document.getElementById("targetAdkk").value);
        if(!inputAdkk || currentPrice === 0) {
            document.getElementById("costPreview").innerText = "";
            usdtCost = 0;
            return;
        }
        usdtCost = inputAdkk * currentPrice;
        document.getElementById("costPreview").innerText = `â‰ˆ é¢„è®¡æ¶ˆè€—: ${usdtCost.toFixed(4)} USDT`;
    }

    // --- äº¤æ˜“æ‰§è¡Œ ---
    async function triggerBuyback() {
        if(!signer) return showToast("è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·", "error");
        if(usdtCost <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„ ADKK æ•°é‡", "error");

        const contract = new ethers.Contract(BUYBACK_ADDR, ABI_BUY, signer);
        try {
            showToast("æ­£åœ¨å‘é€æ‹‰ç›˜æŒ‡ä»¤...", "info");
            
            const weiAmt = ethers.utils.parseUnits(usdtCost.toFixed(18), 18);
            const tx = await contract.buyUSDT(weiAmt, { gasLimit: 1000000 });
            
            showToast(`äº¤æ˜“å·²å‘é€! Hash: ${tx.hash.substring(0,6)}...`, "info");
            await tx.wait();
            
            showToast("ğŸš€ æ‹‰ç›˜æˆåŠŸï¼Kçº¿å·²èµ·é£ï¼", "success");
            
            // äº¤æ˜“æˆåŠŸåï¼Œè¾“å…¥æ¡†æ¸…ç©ºï¼Œæ•°æ®åˆ·æ–°
            document.getElementById("targetAdkk").value = "";
            document.getElementById("costPreview").innerText = "";
            refreshDashboard();

        } catch(e) {
            showToast("æ‹‰ç›˜å¤±è´¥: " + (e.reason || "æœªçŸ¥é”™è¯¯"), "error");
        }
    }

    async function processLP() {
        if(!signer) return showToast("è¯·å…ˆç™»å½•", "error");
        const contract = new ethers.Contract(LP_FUND_ADDR, ABI_LP, signer);
        try {
            showToast("æ­£åœ¨æ‰§è¡ŒåŠ æ± ...", "info");
            const tx = await contract.process({ gasLimit: 3000000 });
            await tx.wait();
            showToast("âœ… åŠ æ± æˆåŠŸï¼åº•æ± å·²å¢åšã€‚", "success");
            refreshDashboard();
        } catch(e) {
            showToast("åŠ æ± å¤±è´¥: " + (e.reason || e.message), "error");
        }
    }
</script>
</body>
</html>
